-----------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Notes/Logs/04_processing_income.log
  log type:  text
 opened on:  10 Feb 2026, 18:19:02

. 
. use "${PROCESSED}/analysis_ready.dta", clear

. 
. * Keep all variables; only modify income series below
. 
. * Require income series to exist
. capture unab _lab_any : labor_income_*

. if _rc {
.     display as error "04: labor_income_* not found in analysis_ready.dta. Run 02_compute_returns_income.d
> o and 03_prep_controls.do first."
.     log close
.     exit 0
. }

. capture unab _tot_any : total_income_*

. if _rc {
.     display as error "04: total_income_* not found in analysis_ready.dta. Run 02_compute_returns_income.d
> o and 03_prep_controls.do first."
.     log close
.     exit 0
. }

. 
. * Year list (even years, 2000â€“2022)
. local years "2000 2002 2004 2006 2008 2010 2012 2014 2016 2018 2020 2022"

. 
. * Ensure income stubs exist and build varlists
. local labvars ""

. local totvars ""

. foreach y of local years {
  2.     capture confirm variable labor_income_`y'
  3.     if _rc {
  4.         gen double labor_income_`y' = .
  5.     }
  6.     capture confirm variable total_income_`y'
  7.     if _rc {
  8.         gen double total_income_`y' = .
  9.     }
 10.     local labvars "`labvars' labor_income_`y'"
 11.     local totvars "`totvars' total_income_`y'"
 12. }
(45,234 missing values generated)
(45,234 missing values generated)

. 
. * ---------------------------------------------------------------------
. * Deflate to 2021 dollars using CPI (CPIAUCSL.csv from FRED)
. * ---------------------------------------------------------------------
. display "=== Deflation to 2021 dollars ==="
=== Deflation to 2021 dollars ===

. tempfile cpi

. preserve

. import delimited "${FRED_DATA}/CPIAUCSL.csv", clear
(encoding automatically selected: ISO-8859-1)
(3 vars, 948 obs)

. capture confirm variable date

. if _rc {
.     capture confirm variable DATE
.     if !_rc rename DATE date
. }

. capture confirm variable CPIAUCSL

. if _rc {
.     capture confirm variable cpiaucsl
.     if !_rc rename cpiaucsl CPIAUCSL
. }

. gen year = real(substr(date,1,4))

. collapse (mean) CPIAUCSL, by(year)

. rename CPIAUCSL cpi

. save "`cpi'", replace
(file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_70631.000002 not found)
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_70631.000002 saved as .dta format

. 
. quietly summarize cpi if year == 2021

. local cpi_2021 = r(mean)

. foreach y of local years {
  2.     quietly summarize cpi if year == `y'
  3.     local cpi_`y' = r(mean)
  4. }

. restore

. 
. display "Tabstat income before deflation"
Tabstat income before deflation

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  lab~2000  lab~2002  lab~2004  lab~2006  lab~2008  lab~2010  lab~2012  lab~2014  lab~2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  10773.54   14165.7  13128.49  12812.57  17190.45   16536.6  16099.66  20480.91
      SD |         .  28083.09   37124.1  57524.24  35307.18   38784.9  39818.89  41015.19  47428.68
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .     57000     70000     67000     70000     82000     81000     83000    100000
     p99 |         .    115000    140000  132273.2  140875.1  154418.2    160000  168731.4  190660.2
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .    757000   2000000   6525000   1425000   1400000   1053000   1600000   1400000
----------------------------------------------------------------------------------------------------

   Stats |  lab~2018  lab~2020  lab~2022  tot~2000  tot~2002  tot~2004  tot~2006  tot~2008  tot~2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  20128.43  20092.79  21690.91         .  37026.81  41800.37  46586.64  48611.16  43426.45
      SD |   59975.8  54200.87  52520.89         .  84838.98  86267.02  301749.7  466212.2  86623.62
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .      2566      2256      3300      3600       700
     p50 |         0         0         0         .     20040     22000     22800     23612     23554
     p95 |     99000    100000    108000         .  115599.5    134360  133737.7  145023.4  135302.3
     p99 |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
     Min |         0         0         0         .         0         0         0         0         0
     Max |   3260000   2500000   1200000         .   7395354   3536773  2.54e+07  6.00e+07   5438860
----------------------------------------------------------------------------------------------------

   Stats |  tot~2012  tot~2014  tot~2016  tot~2018  tot~2020  tot~2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  44823.46  47629.47  51788.15  53714.35  53990.98  59025.53
      SD |  87167.35  129245.5  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0         0         0
      p5 |      1040      1200       192       100       700       276
     p50 |     23526     24450  25971.05     26000  27750.42   29142.1
     p95 |    142004    145508  162177.6    167500    173600    194000
     p99 |    330025  355704.5    402260    423990  430294.8  457653.2
     Min |         0         0         0         0         0         0
     Max |   3663276  1.09e+07  1.00e+07   7366716   5731600   4702364
----------------------------------------------------------------------

. 
. local labreal ""

. local totreal ""

. foreach y of local years {
  2.     local cpi_y = `cpi_`y''
  3.     capture drop labor_income_real_`y' total_income_real_`y'
  4.     if "`cpi_y'" != "" {
  5.         gen double labor_income_real_`y' = labor_income_`y' * (`cpi_2021' / `cpi_y')
  6.         gen double total_income_real_`y' = total_income_`y' * (`cpi_2021' / `cpi_y')
  7.     }
  8.     else {
  9.         gen double labor_income_real_`y' = .
 10.         gen double total_income_real_`y' = .
 11.     }
 12.     local labreal "`labreal' labor_income_real_`y'"
 13.     local totreal "`totreal' total_income_real_`y'"
 14. }
(45,234 missing values generated)
(45,234 missing values generated)
(27,069 missing values generated)
(27,069 missing values generated)
(25,105 missing values generated)
(25,105 missing values generated)
(26,765 missing values generated)
(26,765 missing values generated)
(28,017 missing values generated)
(28,017 missing values generated)
(23,200 missing values generated)
(23,200 missing values generated)
(24,680 missing values generated)
(24,680 missing values generated)
(26,487 missing values generated)
(26,487 missing values generated)
(24,322 missing values generated)
(24,322 missing values generated)
(28,088 missing values generated)
(28,088 missing values generated)
(29,511 missing values generated)
(29,511 missing values generated)
(29,378 missing values generated)
(29,378 missing values generated)

. 
. display "Tabstat income after deflation"
Tabstat income after deflation

. tabstat `labreal' `totreal', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~l_2000  l~l_2002  l~l_2004  l~l_2006  l~l_2008  l~l_2010  l~l_2012  l~l_2014  l~l_2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  16230.27  20319.12  17649.47  16128.81  21359.79  19517.25   18429.3   23123.1
      SD |         .  42306.98  53250.39  77333.56  44445.64  48191.71  46996.07  46950.14  53547.33
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .  85870.12  100407.2  90072.44  88117.91  101888.1  95599.88  95010.19  112900.8
     p99 |         .  173246.7  200814.4  177823.4  177337.5  191870.4  188839.3    193147  215256.8
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .   1140415   2868777   8771980   1793829   1739553   1242798   1831522   1580611
----------------------------------------------------------------------------------------------------

   Stats |  l~l_2018  l~l_2020  l~l_2022  t~l_2000  t~l_2002  t~l_2004  t~l_2006  t~l_2008  t~l_2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  21721.11  21032.96  20085.54         .  55780.64  59957.97  62629.43  61193.05  53959.02
      SD |  64721.42  56736.99  48633.77         .  127809.3  123740.4  405661.7  586880.6  107633.1
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .  3865.662   3235.98  4436.404  4531.778  869.7766
     p50 |         0         0         0         .  30190.13  31556.55  30651.52  29723.43  29266.74
     p95 |  106833.4  104679.1  100006.8         .  174149.9  192724.4  179792.2  182559.4  168118.3
     p99 |  210429.5  204124.3  208347.5         .  416775.3  444681.9  452135.4  439330.7  377045.7
     Min |         0         0         0         .         0         0         0         0         0
     Max |   3517950   2616978   1111187         .  1.11e+07   5073107  3.41e+07  7.55e+07   6757990
----------------------------------------------------------------------------------------------------

   Stats |  t~l_2012  t~l_2014  t~l_2016  t~l_2018  t~l_2020  t~l_2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  52902.68  54521.51  58469.22  57964.53  56517.28  54656.99
      SD |  102878.9  147947.5  164525.2  146572.3  117526.6  119298.6
      p1 |         0         0         0         0         0         0
      p5 |  1227.455  1373.641  216.7694  107.9126  732.7539   255.573
     p50 |  27766.46  27987.94  29321.51  28057.27   29048.9  26985.26
     p95 |  167599.6  166563.2  183099.8  180753.6    181723  179641.9
     p99 |  389510.5  407175.4  454154.6  457538.5  450428.9  423781.9
     Min |         0         0         0         0         0         0
     Max |   4323565  1.25e+07  1.13e+07   7949613   5999789   4354338
----------------------------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Winsorize deflated levels (separate toggle on deflated series)
. * ---------------------------------------------------------------------
. display "=== 1% winsorization on deflated levels ==="
=== 1% winsorization on deflated levels ===

. display "Tabstat deflated income before winsorization"
Tabstat deflated income before winsorization

. tabstat `labreal' `totreal', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~l_2000  l~l_2002  l~l_2004  l~l_2006  l~l_2008  l~l_2010  l~l_2012  l~l_2014  l~l_2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  16230.27  20319.12  17649.47  16128.81  21359.79  19517.25   18429.3   23123.1
      SD |         .  42306.98  53250.39  77333.56  44445.64  48191.71  46996.07  46950.14  53547.33
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .  85870.12  100407.2  90072.44  88117.91  101888.1  95599.88  95010.19  112900.8
     p99 |         .  173246.7  200814.4  177823.4  177337.5  191870.4  188839.3    193147  215256.8
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .   1140415   2868777   8771980   1793829   1739553   1242798   1831522   1580611
----------------------------------------------------------------------------------------------------

   Stats |  l~l_2018  l~l_2020  l~l_2022  t~l_2000  t~l_2002  t~l_2004  t~l_2006  t~l_2008  t~l_2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  21721.11  21032.96  20085.54         .  55780.64  59957.97  62629.43  61193.05  53959.02
      SD |  64721.42  56736.99  48633.77         .  127809.3  123740.4  405661.7  586880.6  107633.1
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .  3865.662   3235.98  4436.404  4531.778  869.7766
     p50 |         0         0         0         .  30190.13  31556.55  30651.52  29723.43  29266.74
     p95 |  106833.4  104679.1  100006.8         .  174149.9  192724.4  179792.2  182559.4  168118.3
     p99 |  210429.5  204124.3  208347.5         .  416775.3  444681.9  452135.4  439330.7  377045.7
     Min |         0         0         0         .         0         0         0         0         0
     Max |   3517950   2616978   1111187         .  1.11e+07   5073107  3.41e+07  7.55e+07   6757990
----------------------------------------------------------------------------------------------------

   Stats |  t~l_2012  t~l_2014  t~l_2016  t~l_2018  t~l_2020  t~l_2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  52902.68  54521.51  58469.22  57964.53  56517.28  54656.99
      SD |  102878.9  147947.5  164525.2  146572.3  117526.6  119298.6
      p1 |         0         0         0         0         0         0
      p5 |  1227.455  1373.641  216.7694  107.9126  732.7539   255.573
     p50 |  27766.46  27987.94  29321.51  28057.27   29048.9  26985.26
     p95 |  167599.6  166563.2  183099.8  180753.6    181723  179641.9
     p99 |  389510.5  407175.4  454154.6  457538.5  450428.9  423781.9
     Min |         0         0         0         0         0         0
     Max |   4323565  1.25e+07  1.13e+07   7949613   5999789   4354338
----------------------------------------------------------------------

. 
. local labrealwin ""

. local totrealwin ""

. foreach y of local years {
  2.     quietly summarize labor_income_real_`y', detail
  3.     local p1_lab = r(p1)
  4.     local p99_lab = r(p99)
  5.     capture drop labor_income_real_win_`y'
  6.     gen double labor_income_real_win_`y' = labor_income_real_`y'
  7.     replace labor_income_real_win_`y' = `p1_lab' if labor_income_real_win_`y' < `p1_lab' & !missing(la
> bor_income_real_win_`y')
  8.     replace labor_income_real_win_`y' = `p99_lab' if labor_income_real_win_`y' > `p99_lab' & !missing(
> labor_income_real_win_`y')
  9. 
.     quietly summarize total_income_real_`y', detail
 10.     local p1_tot = r(p1)
 11.     local p99_tot = r(p99)
 12.     capture drop total_income_real_win_`y'
 13.     gen double total_income_real_win_`y' = total_income_real_`y'
 14.     replace total_income_real_win_`y' = `p1_tot' if total_income_real_win_`y' < `p1_tot' & !missing(to
> tal_income_real_win_`y')
 15.     replace total_income_real_win_`y' = `p99_tot' if total_income_real_win_`y' > `p99_tot' & !missing(
> total_income_real_win_`y')
 16. 
.     local labrealwin "`labrealwin' labor_income_real_win_`y'"
 17.     local totrealwin "`totrealwin' total_income_real_win_`y'"
 18. }
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(27,069 missing values generated)
(0 real changes made)
(183 real changes made)
(27,069 missing values generated)
(0 real changes made)
(181 real changes made)
(25,105 missing values generated)
(0 real changes made)
(203 real changes made)
(25,105 missing values generated)
(0 real changes made)
(201 real changes made)
(26,765 missing values generated)
(0 real changes made)
(185 real changes made)
(26,765 missing values generated)
(0 real changes made)
(184 real changes made)
(28,017 missing values generated)
(0 real changes made)
(172 real changes made)
(28,017 missing values generated)
(0 real changes made)
(172 real changes made)
(23,200 missing values generated)
(0 real changes made)
(221 real changes made)
(23,200 missing values generated)
(0 real changes made)
(220 real changes made)
(24,680 missing values generated)
(0 real changes made)
(205 real changes made)
(24,680 missing values generated)
(0 real changes made)
(205 real changes made)
(26,487 missing values generated)
(0 real changes made)
(187 real changes made)
(26,487 missing values generated)
(0 real changes made)
(187 real changes made)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(28,088 missing values generated)
(0 real changes made)
(172 real changes made)
(28,088 missing values generated)
(0 real changes made)
(171 real changes made)
(29,511 missing values generated)
(0 real changes made)
(157 real changes made)
(29,511 missing values generated)
(0 real changes made)
(158 real changes made)
(29,378 missing values generated)
(0 real changes made)
(154 real changes made)
(29,378 missing values generated)
(0 real changes made)
(158 real changes made)

. 
. display "Tabstat deflated income after winsorization"
Tabstat deflated income after winsorization

. tabstat `labrealwin' `totrealwin', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~n_2000  l~n_2002  l~n_2004  l~n_2006  l~n_2008  l~n_2010  l~n_2012  l~n_2014  l~n_2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  15135.65  19002.57  16158.67  14976.15  20164.64  18249.65  17278.13  21643.79
      SD |         .   32580.9  37650.35  33697.37  32820.09  37831.49  36189.97  36129.72  41288.64
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .  85870.12  100407.2  90072.44  88117.91  101888.1  95599.88  95010.19  112900.8
     p99 |         .  173246.7  200814.4  177823.4  177337.5  191870.4  188839.3    193147  215256.8
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .  173246.7  200814.4  177823.4  177337.5  191870.4  188839.3    193147  215256.8
----------------------------------------------------------------------------------------------------

   Stats |  l~n_2018  l~n_2020  l~n_2022  t~n_2000  t~n_2002  t~n_2004  t~n_2006  t~n_2008  t~n_2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  19847.19   19567.6  18859.67         .   51878.5  55397.86  53489.83  52958.03  50369.49
      SD |  39573.18  39173.18  38345.13         .  66407.29  71841.79  70022.36  69115.31  62362.26
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .  3865.662   3235.98  4436.404  4531.778  869.7766
     p50 |         0         0         0         .  30190.13  31556.55  30651.52  29723.43  29266.74
     p95 |  106833.4  104679.1  100006.8         .  174149.9  192724.4  179792.2  182559.4  168118.3
     p99 |  210429.5  204124.3  208347.5         .  416775.3  444681.9  452135.4  439330.7  377045.7
     Min |         0         0         0         .         0         0         0         0         0
     Max |  210429.5  204124.3  208347.5         .  416775.3  444681.9  452135.4  439330.7  377045.7
----------------------------------------------------------------------------------------------------

   Stats |  t~n_2012  t~n_2014  t~n_2016  t~n_2018  t~n_2020  t~n_2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  49178.34  49727.28  53539.04   52319.7  52701.73  50624.16
      SD |   63012.2  63834.37  71987.89   71354.6  70307.44  68371.47
      p1 |         0         0         0         0         0         0
      p5 |  1227.455  1373.641  216.7694  107.9126  732.7539   255.573
     p50 |  27766.46  27987.94  29321.51  28057.27   29048.9  26985.26
     p95 |  167599.6  166563.2  183099.8  180753.6    181723  179641.9
     p99 |  389510.5  407175.4  454154.6  457538.5  450428.9  423781.9
     Min |         0         0         0         0         0         0
     Max |  389510.5  407175.4  454154.6  457538.5  450428.9  423781.9
----------------------------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Log income (separate toggle on original series)
. * ---------------------------------------------------------------------
. display "=== Log income (original series) ==="
=== Log income (original series) ===

. display "Tabstat income before logs"
Tabstat income before logs

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  10773.54   14165.7  13128.49  12812.57  17190.45   16536.6  16099.66  20480.91
      SD |         .  28083.09   37124.1  57524.24  35307.18   38784.9  39818.89  41015.19  47428.68
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .     57000     70000     67000     70000     82000     81000     83000    100000
     p99 |         .    115000    140000  132273.2  140875.1  154418.2    160000  168731.4  190660.2
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .    757000   2000000   6525000   1425000   1400000   1053000   1600000   1400000
----------------------------------------------------------------------------------------------------

   Stats |  l~e_2018  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  20128.43  20092.79  21690.91         .  37026.81  41800.37  46586.64  48611.16  43426.45
      SD |   59975.8  54200.87  52520.89         .  84838.98  86267.02  301749.7  466212.2  86623.62
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .      2566      2256      3300      3600       700
     p50 |         0         0         0         .     20040     22000     22800     23612     23554
     p95 |     99000    100000    108000         .  115599.5    134360  133737.7  145023.4  135302.3
     p99 |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
     Min |         0         0         0         .         0         0         0         0         0
     Max |   3260000   2500000   1200000         .   7395354   3536773  2.54e+07  6.00e+07   5438860
----------------------------------------------------------------------------------------------------

   Stats |  t~e_2012  t~e_2014  t~e_2016  t~e_2018  total_..  t~e_2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  44823.46  47629.47  51788.15  53714.35  53990.98  59025.53
      SD |  87167.35  129245.5  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0         0         0
      p5 |      1040      1200       192       100       700       276
     p50 |     23526     24450  25971.05     26000  27750.42   29142.1
     p95 |    142004    145508  162177.6    167500    173600    194000
     p99 |    330025  355704.5    402260    423990  430294.8  457653.2
     Min |         0         0         0         0         0         0
     Max |   3663276  1.09e+07  1.00e+07   7366716   5731600   4702364
----------------------------------------------------------------------

. 
. local lablog ""

. local totlog ""

. foreach y of local years {
  2.     capture drop ln_lab_inc_`y' ln_tot_inc_`y'
  3.     gen double ln_lab_inc_`y' = ln(labor_income_`y') if labor_income_`y' > 0
  4.     gen double ln_tot_inc_`y' = ln(total_income_`y') if total_income_`y' > 0
  5.     local lablog "`lablog' ln_lab_inc_`y'"
  6.     local totlog "`totlog' ln_tot_inc_`y'"
  7. }
(45,234 missing values generated)
(45,234 missing values generated)
(39,578 missing values generated)
(27,432 missing values generated)
(37,779 missing values generated)
(25,532 missing values generated)
(39,112 missing values generated)
(27,089 missing values generated)
(39,857 missing values generated)
(28,341 missing values generated)
(36,542 missing values generated)
(23,967 missing values generated)
(37,660 missing values generated)
(25,362 missing values generated)
(38,812 missing values generated)
(27,092 missing values generated)
(37,106 missing values generated)
(25,198 missing values generated)
(38,920 missing values generated)
(28,847 missing values generated)
(39,551 missing values generated)
(30,142 missing values generated)
(39,519 missing values generated)
(30,039 missing values generated)

. 
. display "Tabstat log income after logs"
Tabstat log income after logs

. tabstat `lablog' `totlog', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  ln_la~00  ln_la~02  ln_la~04  ln_la~06  ln_la~08  ln_la~10  ln_la~12  ln_la~14  ln_la~16
---------+------------------------------------------------------------------------------------------
       N |         0      5656      7455      6122      5377      8692      7574      6422      8128
    Mean |         .  9.886746  9.962517  10.00025  10.01752  10.11673  10.12727  10.15028  10.29516
      SD |         .  1.278154  1.289539  1.243734  1.305799  1.261875  1.273703  1.313855  1.291232
      p1 |         .  5.703782  5.521461  6.052089  5.924256  5.991465  5.991465  5.991465  5.991465
      p5 |         .  7.600902  7.600902  7.600902  7.600902  7.600902  7.600902  7.600902  7.696213
     p50 |         .  10.12663  10.17732  10.22194  10.23996  10.34174  10.30895  10.37349  10.51867
     p95 |         .  11.49272  11.58989  11.58058  11.67844  11.70355  11.77529  11.82041  11.91839
     p99 |         .  12.12811  12.20607  12.20607  12.28303  12.30138  12.42922  12.42922  12.61154
     Min |         .  1.609438  1.791759  3.433987         0  2.995732  2.995732   2.70805  2.302585
     Max |         .  13.53712  14.50866  15.69115  14.16968  14.15198  13.86715  14.28551  14.15198
----------------------------------------------------------------------------------------------------

   Stats |  ln_la~18  ln_la~20  ln_la~22  ln_to~00  ln_to~02  ln_to~04  ln_to~06  ln_to~08  ln_to~10
---------+------------------------------------------------------------------------------------------
       N |      6314      5683      5715         0     17802     19702     18145     16893     21267
    Mean |  10.28425  10.30675  10.37011         .  9.909088    9.9914   10.0362  10.09974  10.07582
      SD |  1.327086    1.3485  1.380742         .  1.182881  1.247326  1.201174  1.175945  1.252513
      p1 |  5.762051  5.910797  5.703782         .  5.991465   5.63479  6.082219   6.44572  5.733341
      p5 |  7.600902  7.600902  7.600902         .   8.34284  8.337109  8.476371  8.548692   8.29405
     p50 |  10.51867  10.59663  10.64542         .  9.927228  10.02924  10.05449  10.09278  10.12548
     p95 |  11.93164  11.98293  12.05525         .  11.66822  11.81377  11.80932  11.89764  11.84151
     p99 |  12.58908    12.544  12.70685         .  12.53637  12.66931   12.7308  12.76632  12.65172
     Min |         0  2.197225  2.772589         .         0         0         0         0         0
     Max |  14.99724   14.7318  13.99783         .  15.81636  15.07873  17.04869  17.91009  15.50908
----------------------------------------------------------------------------------------------------

   Stats |  ln_to~12  ln_to~14  ln_to~16  ln_to~18  ln_to~20  ln_to~22
---------+------------------------------------------------------------
       N |     19872     18142     20036     16387     15092     15195
    Mean |  10.09054   10.1366  10.18113  10.20303  10.27584  10.33174
      SD |  1.229532  1.240228  1.325237  1.311782  1.228546  1.276795
      p1 |  5.991465  5.981414  5.620401  5.703782   6.49224  5.891644
      p5 |   8.30499  8.455318  8.273081  8.318742  8.525161  8.517193
     p50 |  10.11261  10.14201  10.23038  10.23287   10.2974  10.33202
     p95 |  11.88034   11.9072  12.02934  12.05525  12.08616  12.20408
     p99 |  12.71926  12.79468  12.93663  12.96924  12.99237  13.06393
     Min |         0 -1.832581 -2.120264         0         0         0
     Max |  15.11387  16.20778  16.12169  15.81248  15.56151  15.36358
----------------------------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Trim top/bottom 1% on levels (separate toggle on original series)
. * ---------------------------------------------------------------------
. display "=== 1% trimming on levels (original series) ==="
=== 1% trimming on levels (original series) ===

. display "Tabstat income before trimming"
Tabstat income before trimming

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  10773.54   14165.7  13128.49  12812.57  17190.45   16536.6  16099.66  20480.91
      SD |         .  28083.09   37124.1  57524.24  35307.18   38784.9  39818.89  41015.19  47428.68
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .     57000     70000     67000     70000     82000     81000     83000    100000
     p99 |         .    115000    140000  132273.2  140875.1  154418.2    160000  168731.4  190660.2
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .    757000   2000000   6525000   1425000   1400000   1053000   1600000   1400000
----------------------------------------------------------------------------------------------------

   Stats |  l~e_2018  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  20128.43  20092.79  21690.91         .  37026.81  41800.37  46586.64  48611.16  43426.45
      SD |   59975.8  54200.87  52520.89         .  84838.98  86267.02  301749.7  466212.2  86623.62
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .      2566      2256      3300      3600       700
     p50 |         0         0         0         .     20040     22000     22800     23612     23554
     p95 |     99000    100000    108000         .  115599.5    134360  133737.7  145023.4  135302.3
     p99 |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
     Min |         0         0         0         .         0         0         0         0         0
     Max |   3260000   2500000   1200000         .   7395354   3536773  2.54e+07  6.00e+07   5438860
----------------------------------------------------------------------------------------------------

   Stats |  t~e_2012  t~e_2014  t~e_2016  t~e_2018  total_..  t~e_2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  44823.46  47629.47  51788.15  53714.35  53990.98  59025.53
      SD |  87167.35  129245.5  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0         0         0
      p5 |      1040      1200       192       100       700       276
     p50 |     23526     24450  25971.05     26000  27750.42   29142.1
     p95 |    142004    145508  162177.6    167500    173600    194000
     p99 |    330025  355704.5    402260    423990  430294.8  457653.2
     Min |         0         0         0         0         0         0
     Max |   3663276  1.09e+07  1.00e+07   7366716   5731600   4702364
----------------------------------------------------------------------

. 
. local labtrim ""

. local tottrim ""

. foreach y of local years {
  2.     quietly summarize labor_income_`y', detail
  3.     local p1_lab = r(p1)
  4.     local p99_lab = r(p99)
  5.     capture drop labor_income_trim_`y'
  6.     gen double labor_income_trim_`y' = labor_income_`y'
  7.     replace labor_income_trim_`y' = . if labor_income_trim_`y' < `p1_lab' | labor_income_trim_`y' > `p
> 99_lab'
  8. 
.     quietly summarize total_income_`y', detail
  9.     local p1_tot = r(p1)
 10.     local p99_tot = r(p99)
 11.     capture drop total_income_trim_`y'
 12.     gen double total_income_trim_`y' = total_income_`y'
 13.     replace total_income_trim_`y' = . if total_income_trim_`y' < `p1_tot' | total_income_trim_`y' > `p
> 99_tot'
 14. 
.     local labtrim "`labtrim' labor_income_trim_`y'"
 15.     local tottrim "`tottrim' total_income_trim_`y'"
 16. }
(45,234 missing values generated)
(0 real changes made)
(45,234 missing values generated)
(0 real changes made)
(27,069 missing values generated)
(172 real changes made, 172 to missing)
(27,069 missing values generated)
(181 real changes made, 181 to missing)
(25,105 missing values generated)
(189 real changes made, 189 to missing)
(25,105 missing values generated)
(201 real changes made, 201 to missing)
(26,765 missing values generated)
(185 real changes made, 185 to missing)
(26,765 missing values generated)
(184 real changes made, 184 to missing)
(28,017 missing values generated)
(173 real changes made, 173 to missing)
(28,017 missing values generated)
(172 real changes made, 172 to missing)
(23,200 missing values generated)
(220 real changes made, 220 to missing)
(23,200 missing values generated)
(220 real changes made, 220 to missing)
(24,680 missing values generated)
(205 real changes made, 205 to missing)
(24,680 missing values generated)
(205 real changes made, 205 to missing)
(26,487 missing values generated)
(187 real changes made, 187 to missing)
(26,487 missing values generated)
(187 real changes made, 187 to missing)
(24,322 missing values generated)
(209 real changes made, 209 to missing)
(24,322 missing values generated)
(209 real changes made, 209 to missing)
(28,088 missing values generated)
(168 real changes made, 168 to missing)
(28,088 missing values generated)
(171 real changes made, 171 to missing)
(29,511 missing values generated)
(157 real changes made, 157 to missing)
(29,511 missing values generated)
(157 real changes made, 157 to missing)
(29,378 missing values generated)
(154 real changes made, 154 to missing)
(29,378 missing values generated)
(158 real changes made, 158 to missing)

. 
. display "Tabstat income after trimming"
Tabstat income after trimming

. tabstat `labtrim' `tottrim', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~m_2000  l~m_2002  l~m_2004  l~m_2006  l~m_2008  l~m_2010  l~m_2012  l~m_2014  l~m_2016
---------+------------------------------------------------------------------------------------------
       N |         0     17993     19940     18284     17044     21814     20349     18560     20703
    Mean |         .  9043.668  12046.44  10802.81  10587.75  14834.91  14006.49  13546.04  17439.42
      SD |         .  19128.21  23276.05   22064.4  22717.19  27236.43   27149.7  27676.71   32419.5
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .     52000     63000     60000     62000     75000     75000     75000     90000
     p99 |         .     89000    106000    100000    106000    120000    125000    129000  149977.9
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .    115000    140000    132000    140000  154418.2    160000  168731.4  190660.2
----------------------------------------------------------------------------------------------------

   Stats |  l~m_2018  l~m_2020  l~m_2022  t~m_2000  t~m_2002  t~m_2004  t~m_2006  t~m_2008  t~m_2010
---------+------------------------------------------------------------------------------------------
       N |     16978     15566     15702         0     17984     19928     18285     17045     21814
    Mean |  16644.35  16914.68  18360.08         .  31998.82  35883.88  36804.22  38972.12  37886.07
      SD |  32348.13  33133.71  36288.48         .  36962.42  42230.41  42970.31  45657.93  42897.65
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .      2500      2200      3230      3600       630
     p50 |         0         0         0         .     19822  21715.03  22435.97     23220     23160
     p95 |     89000     92000    100000         .  104904.3  120099.4  119973.9    129580  123735.7
     p99 |    150000    150000  166016.7         .  195815.4  220317.9    224800    237200    220500
     Min |         0         0         0         .         0         0         0         0         0
     Max |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
----------------------------------------------------------------------------------------------------

   Stats |  t~m_2012  t~m_2014  t~m_2016  t~m_2018  t~m_2020  t~m_2022
---------+------------------------------------------------------------
       N |     20349     18560     20703     16975     15566     15698
    Mean |  38762.93  40295.09  43839.18   44700.7  46513.79  50614.36
      SD |  45088.36  46353.96  53128.81  54602.35  55549.83  62093.43
      p1 |         0         0         0         0         0         0
      p5 |      1000      1134       160        90       600       240
     p50 |  23087.28  24050.41     25456     25540   27432.7     28800
     p95 |    129992    131198  148361.7    152320    157000    174040
     p99 |  233091.7    231600    273600    281000    288732  322031.1
     Min |         0         0         0         0         0         0
     Max |    330025  355704.5    402260    423990  430294.8  457653.2
----------------------------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Winsorize top/bottom 1% on levels (separate toggle on original series)
. * ---------------------------------------------------------------------
. display "=== 1% winsorization on levels (original series) ==="
=== 1% winsorization on levels (original series) ===

. display "Tabstat income before winsorization"
Tabstat income before winsorization

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  10773.54   14165.7  13128.49  12812.57  17190.45   16536.6  16099.66  20480.91
      SD |         .  28083.09   37124.1  57524.24  35307.18   38784.9  39818.89  41015.19  47428.68
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .     57000     70000     67000     70000     82000     81000     83000    100000
     p99 |         .    115000    140000  132273.2  140875.1  154418.2    160000  168731.4  190660.2
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .    757000   2000000   6525000   1425000   1400000   1053000   1600000   1400000
----------------------------------------------------------------------------------------------------

   Stats |  l~e_2018  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  20128.43  20092.79  21690.91         .  37026.81  41800.37  46586.64  48611.16  43426.45
      SD |   59975.8  54200.87  52520.89         .  84838.98  86267.02  301749.7  466212.2  86623.62
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .      2566      2256      3300      3600       700
     p50 |         0         0         0         .     20040     22000     22800     23612     23554
     p95 |     99000    100000    108000         .  115599.5    134360  133737.7  145023.4  135302.3
     p99 |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
     Min |         0         0         0         .         0         0         0         0         0
     Max |   3260000   2500000   1200000         .   7395354   3536773  2.54e+07  6.00e+07   5438860
----------------------------------------------------------------------------------------------------

   Stats |  t~e_2012  t~e_2014  t~e_2016  t~e_2018  total_..  t~e_2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  44823.46  47629.47  51788.15  53714.35  53990.98  59025.53
      SD |  87167.35  129245.5  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0         0         0
      p5 |      1040      1200       192       100       700       276
     p50 |     23526     24450  25971.05     26000  27750.42   29142.1
     p95 |    142004    145508  162177.6    167500    173600    194000
     p99 |    330025  355704.5    402260    423990  430294.8  457653.2
     Min |         0         0         0         0         0         0
     Max |   3663276  1.09e+07  1.00e+07   7366716   5731600   4702364
----------------------------------------------------------------------

. 
. local labwin ""

. local totwin ""

. foreach y of local years {
  2.     quietly summarize labor_income_`y', detail
  3.     local p1_lab = r(p1)
  4.     local p99_lab = r(p99)
  5.     capture drop labor_income_win_`y'
  6.     gen double labor_income_win_`y' = labor_income_`y'
  7.     replace labor_income_win_`y' = `p1_lab' if labor_income_win_`y' < `p1_lab' & !missing(labor_income
> _win_`y')
  8.     replace labor_income_win_`y' = `p99_lab' if labor_income_win_`y' > `p99_lab' & !missing(labor_inco
> me_win_`y')
  9. 
.     quietly summarize total_income_`y', detail
 10.     local p1_tot = r(p1)
 11.     local p99_tot = r(p99)
 12.     capture drop total_income_win_`y'
 13.     gen double total_income_win_`y' = total_income_`y'
 14.     replace total_income_win_`y' = `p1_tot' if total_income_win_`y' < `p1_tot' & !missing(total_income
> _win_`y')
 15.     replace total_income_win_`y' = `p99_tot' if total_income_win_`y' > `p99_tot' & !missing(total_inco
> me_win_`y')
 16. 
.     local labwin "`labwin' labor_income_win_`y'"
 17.     local totwin "`totwin' total_income_win_`y'"
 18. }
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(27,069 missing values generated)
(0 real changes made)
(172 real changes made)
(27,069 missing values generated)
(0 real changes made)
(181 real changes made)
(25,105 missing values generated)
(0 real changes made)
(189 real changes made)
(25,105 missing values generated)
(0 real changes made)
(201 real changes made)
(26,765 missing values generated)
(0 real changes made)
(185 real changes made)
(26,765 missing values generated)
(0 real changes made)
(184 real changes made)
(28,017 missing values generated)
(0 real changes made)
(173 real changes made)
(28,017 missing values generated)
(0 real changes made)
(172 real changes made)
(23,200 missing values generated)
(0 real changes made)
(220 real changes made)
(23,200 missing values generated)
(0 real changes made)
(220 real changes made)
(24,680 missing values generated)
(0 real changes made)
(205 real changes made)
(24,680 missing values generated)
(0 real changes made)
(205 real changes made)
(26,487 missing values generated)
(0 real changes made)
(187 real changes made)
(26,487 missing values generated)
(0 real changes made)
(187 real changes made)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(28,088 missing values generated)
(0 real changes made)
(168 real changes made)
(28,088 missing values generated)
(0 real changes made)
(171 real changes made)
(29,511 missing values generated)
(0 real changes made)
(157 real changes made)
(29,511 missing values generated)
(0 real changes made)
(157 real changes made)
(29,378 missing values generated)
(0 real changes made)
(154 real changes made)
(29,378 missing values generated)
(0 real changes made)
(158 real changes made)

. 
. display "Tabstat income after winsorization"
Tabstat income after winsorization

. tabstat `labwin' `totwin', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  10046.94  13247.85  12019.56   11896.9  16228.59  15462.59  15094.01  19170.63
      SD |         .  21626.98  26248.36  25065.65  26071.96  30446.95  30663.09  31562.58  36570.74
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .     57000     70000     67000     70000     82000     81000     83000    100000
     p99 |         .    115000    140000  132273.2  140875.1  154418.2    160000  168731.4  190660.2
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .    115000    140000  132273.2  140875.1  154418.2    160000  168731.4  190660.2
----------------------------------------------------------------------------------------------------

   Stats |  labor_..  labor_..  labor_..  total_..  total_..  total_..  total_..  total_..  total_..
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  18391.92  18692.93  20367.06         .   34436.6  38621.24  39788.18  42069.33  40537.59
      SD |  36671.52  37422.15  41409.92         .  44080.71  50085.31  52085.84  54904.52  50189.42
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .      2566      2256      3300      3600       700
     p50 |         0         0         0         .     20040     22000     22800     23612     23554
     p95 |     99000    100000    108000         .  115599.5    134360  133737.7  145023.4  135302.3
     p99 |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
     Min |         0         0         0         .         0         0         0         0         0
     Max |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
----------------------------------------------------------------------------------------------------

   Stats |  total_..  total_..  total_..  total_..  total_..  total_..
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |   41667.9  43441.28  47421.33  48483.41  50345.98  54670.37
      SD |  53389.06   55765.1   63762.1   66122.6  67164.72  73836.16
      p1 |         0         0         0         0         0         0
      p5 |      1040      1200       192       100       700       276
     p50 |     23526     24450  25971.05     26000  27750.42   29142.1
     p95 |    142004    145508  162177.6    167500    173600    194000
     p99 |    330025  355704.5    402260    423990  430294.8  457653.2
     Min |         0         0         0         0         0         0
     Max |    330025  355704.5    402260    423990  430294.8  457653.2
----------------------------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Final toggle (apply all: deflate -> log -> winsorize)
. * ---------------------------------------------------------------------
. display "=== Final toggle: deflate->log->winsorize ==="
=== Final toggle: deflate->log->winsorize ===

. display "Tabstat income before final toggle (original series)"
Tabstat income before final toggle (original series)

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  10773.54   14165.7  13128.49  12812.57  17190.45   16536.6  16099.66  20480.91
      SD |         .  28083.09   37124.1  57524.24  35307.18   38784.9  39818.89  41015.19  47428.68
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .     57000     70000     67000     70000     82000     81000     83000    100000
     p99 |         .    115000    140000  132273.2  140875.1  154418.2    160000  168731.4  190660.2
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .    757000   2000000   6525000   1425000   1400000   1053000   1600000   1400000
----------------------------------------------------------------------------------------------------

   Stats |  l~e_2018  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  20128.43  20092.79  21690.91         .  37026.81  41800.37  46586.64  48611.16  43426.45
      SD |   59975.8  54200.87  52520.89         .  84838.98  86267.02  301749.7  466212.2  86623.62
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .      2566      2256      3300      3600       700
     p50 |         0         0         0         .     20040     22000     22800     23612     23554
     p95 |     99000    100000    108000         .  115599.5    134360  133737.7  145023.4  135302.3
     p99 |    195000    195000    225000         .  276652.6    310015    336319    349000    303448
     Min |         0         0         0         .         0         0         0         0         0
     Max |   3260000   2500000   1200000         .   7395354   3536773  2.54e+07  6.00e+07   5438860
----------------------------------------------------------------------------------------------------

   Stats |  t~e_2012  t~e_2014  t~e_2016  t~e_2018  total_..  t~e_2022
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  44823.46  47629.47  51788.15  53714.35  53990.98  59025.53
      SD |  87167.35  129245.5  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0         0         0
      p5 |      1040      1200       192       100       700       276
     p50 |     23526     24450  25971.05     26000  27750.42   29142.1
     p95 |    142004    145508  162177.6    167500    173600    194000
     p99 |    330025  355704.5    402260    423990  430294.8  457653.2
     Min |         0         0         0         0         0         0
     Max |   3663276  1.09e+07  1.00e+07   7366716   5731600   4702364
----------------------------------------------------------------------

. 
. local labfinal ""

. local totfinal ""

. foreach y of local years {
  2.     * Start from deflated series
.     capture confirm variable labor_income_real_`y'
  3.     if _rc {
  4.         gen double labor_income_real_`y' = labor_income_`y' * (`cpi_2021' / `cpi_`y'')
  5.     }
  6.     capture confirm variable total_income_real_`y'
  7.     if _rc {
  8.         gen double total_income_real_`y' = total_income_`y' * (`cpi_2021' / `cpi_`y'')
  9.     }
 10. 
.     * Log: use ln(1+x) so zeros stay in sample (same overlap as RAND; otherwise labor drops 0-earners)
.     capture drop ln_lab_inc_final_`y' ln_tot_inc_final_`y'
 11.     gen double ln_lab_inc_final_`y' = ln(1 + labor_income_real_`y') if !missing(labor_income_real_`y')
 12.     gen double ln_tot_inc_final_`y' = ln(1 + total_income_real_`y') if !missing(total_income_real_`y')
 13. 
.     * Winsorize on log values (p1/p99)
.     quietly summarize ln_lab_inc_final_`y', detail
 14.     local p1_lab = r(p1)
 15.     local p99_lab = r(p99)
 16.     replace ln_lab_inc_final_`y' = `p1_lab' if ln_lab_inc_final_`y' < `p1_lab' & !missing(ln_lab_inc_f
> inal_`y')
 17.     replace ln_lab_inc_final_`y' = `p99_lab' if ln_lab_inc_final_`y' > `p99_lab' & !missing(ln_lab_inc
> _final_`y')
 18. 
.     quietly summarize ln_tot_inc_final_`y', detail
 19.     local p1_tot = r(p1)
 20.     local p99_tot = r(p99)
 21.     replace ln_tot_inc_final_`y' = `p1_tot' if ln_tot_inc_final_`y' < `p1_tot' & !missing(ln_tot_inc_f
> inal_`y')
 22.     replace ln_tot_inc_final_`y' = `p99_tot' if ln_tot_inc_final_`y' > `p99_tot' & !missing(ln_tot_inc
> _final_`y')
 23. 
.     local labfinal "`labfinal' ln_lab_inc_final_`y'"
 24.     local totfinal "`totfinal' ln_tot_inc_final_`y'"
 25. }
(45,234 missing values generated)
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(27,069 missing values generated)
(27,069 missing values generated)
(0 real changes made)
(183 real changes made)
(0 real changes made)
(181 real changes made)
(25,105 missing values generated)
(25,105 missing values generated)
(0 real changes made)
(189 real changes made)
(0 real changes made)
(202 real changes made)
(26,765 missing values generated)
(26,765 missing values generated)
(0 real changes made)
(185 real changes made)
(0 real changes made)
(184 real changes made)
(28,017 missing values generated)
(28,017 missing values generated)
(0 real changes made)
(173 real changes made)
(0 real changes made)
(172 real changes made)
(23,200 missing values generated)
(23,200 missing values generated)
(0 real changes made)
(220 real changes made)
(0 real changes made)
(220 real changes made)
(24,680 missing values generated)
(24,680 missing values generated)
(0 real changes made)
(225 real changes made)
(0 real changes made)
(206 real changes made)
(26,487 missing values generated)
(26,487 missing values generated)
(0 real changes made)
(187 real changes made)
(0 real changes made)
(187 real changes made)
(24,322 missing values generated)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(0 real changes made)
(210 real changes made)
(28,088 missing values generated)
(28,088 missing values generated)
(0 real changes made)
(172 real changes made)
(0 real changes made)
(171 real changes made)
(29,511 missing values generated)
(29,511 missing values generated)
(0 real changes made)
(161 real changes made)
(0 real changes made)
(158 real changes made)
(29,378 missing values generated)
(29,378 missing values generated)
(0 real changes made)
(154 real changes made)
(0 real changes made)
(158 real changes made)

. 
. display "Tabstat income after final toggle (final log series)"
Tabstat income after final toggle (final log series)

. tabstat `labfinal' `totfinal', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..
---------+------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912
    Mean |         .  3.202184  3.819659  3.409112  3.196684  4.072652  3.788772  3.519789   4.04441
      SD |         .  4.813493  5.040085  4.892435  4.797513  5.106013  5.018002  4.934772  5.133817
      p1 |         .         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .   11.3606    11.517  11.40838  11.38644  11.53164  11.46794  11.46175  11.63427
     p99 |         .  12.06248  12.21014  12.08855  12.08582  12.16458  12.14866  12.17121  12.27959
     Min |         .         0         0         0         0         0         0         0         0
     Max |         .  12.06248  12.21014  12.08855  12.08582  12.16458  12.14866  12.17121  12.27959
----------------------------------------------------------------------------------------------------

   Stats |  ln_lab..  ln_lab..  ln_lab..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..
---------+------------------------------------------------------------------------------------------
       N |     17146     15723     15856         0     18165     20129     18469     17217     22034
    Mean |  3.810778  3.737911  3.706272         .  10.10787  10.12738  10.14569   10.1306  9.930161
      SD |  5.053703  5.032249  5.004489         .  1.849233  1.925141  1.792403  1.812943   2.24317
      p1 |         0         0         0         .         0         0         0         0         0
      p5 |         0         0         0         .  8.260147  8.082396  8.397825   8.41909  6.769385
     p50 |         0         0         0         .   10.3153  10.35957  10.33047  10.29972  10.28424
     p95 |  11.57904  11.55866    11.513         .  12.06768  12.16902  12.09956  12.11484  12.03243
     p99 |  12.25691  12.22649  12.24697         .   12.9403  13.00512  13.02174  12.99301  12.84012
     Min |         0         0         0         .         0         0         0         0         0
     Max |  12.25691  12.22649  12.24697         .   12.9403  13.00512  13.02174  12.99301  12.84012
----------------------------------------------------------------------------------------------------

   Stats |  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..
---------+------------------------------------------------------------
       N |     20554     18747     20912     17146     15723     15856
    Mean |  9.910943  9.935594  9.867021  9.819063  9.903135  9.823068
      SD |  2.189429  2.174862  2.425795  2.461387  2.347963  2.391591
      p1 |         0         0         0         0         0         0
      p5 |  7.113513  7.225948  5.383437  4.690545  6.598174  5.547413
     p50 |  10.23162  10.23956  10.28611  10.24204  10.27677  10.20308
     p95 |  12.02934  12.02314  12.11779   12.1049  12.11024  12.09873
     p99 |  12.87265    12.917   13.0262  13.03362  13.01796  12.95698
     Min |         0         0         0         0         0         0
     Max |  12.87265    12.917   13.0262  13.03362  13.01796  12.95698
----------------------------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Income growth from final log series (two-year differences)
. * ---------------------------------------------------------------------
. display "=== Income growth from final log series ==="
=== Income growth from final log series ===

. local labgrowth ""

. local totgrowth ""

. foreach y of local years {
  2.     if `y' > 2000 {
  3.         local yprev = `y' - 2
  4.         capture drop ln_lab_inc_final_growth_`y' ln_tot_inc_final_growth_`y'
  5.         gen double ln_lab_inc_final_growth_`y' = ln_lab_inc_final_`y' - ln_lab_inc_final_`yprev' ///
>             if !missing(ln_lab_inc_final_`y') & !missing(ln_lab_inc_final_`yprev')
  6.         gen double ln_tot_inc_final_growth_`y' = ln_tot_inc_final_`y' - ln_tot_inc_final_`yprev' ///
>             if !missing(ln_tot_inc_final_`y') & !missing(ln_tot_inc_final_`yprev')
  7.         local labgrowth "`labgrowth' ln_lab_inc_final_growth_`y'"
  8.         local totgrowth "`totgrowth' ln_tot_inc_final_growth_`y'"
  9.     }
 10. }
(45,234 missing values generated)
(45,234 missing values generated)
(29,030 missing values generated)
(29,030 missing values generated)
(27,411 missing values generated)
(27,411 missing values generated)
(28,741 missing values generated)
(28,741 missing values generated)
(30,203 missing values generated)
(30,203 missing values generated)
(25,451 missing values generated)
(25,451 missing values generated)
(27,159 missing values generated)
(27,159 missing values generated)
(29,326 missing values generated)
(29,326 missing values generated)
(28,630 missing values generated)
(28,630 missing values generated)
(30,977 missing values generated)
(30,977 missing values generated)
(33,066 missing values generated)
(33,066 missing values generated)

. display "Tabstat income growth (final log series)"
Tabstat income growth (final log series)

. tabstat `labgrowth' `totgrowth', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..
---------+------------------------------------------------------------------------------------------
       N |         0     16204     17823     16493     15031     19783     18075     15908     16604
    Mean |         . -.3634129 -.5385851 -.3984526 -.5142151 -.4241881 -.4670765 -.4790237 -.3569601
      SD |         .   3.40376  3.304629  3.276012  3.286907  3.402217  3.396347   3.53139  3.599057
      p1 |         .  -11.2688 -11.36285 -11.21102 -11.21549 -11.23297 -11.20063 -11.29141 -11.41113
      p5 |         . -9.397064 -9.571149 -9.149693   -9.4406 -9.427577 -9.558455 -9.682019 -9.737203
     p50 |         .         0         0         0         0         0         0         0         0
     p95 |         .  2.071174  1.059026  1.320499  .9479698  1.831105  1.607344  1.882082  4.821761
     p99 |         .  10.56436  10.24823   10.4338  10.13557  10.53924  10.44413  10.58447  10.79059
     Min |         . -12.06248 -12.21014 -12.08855 -12.08582 -12.16458 -12.14866 -12.17121 -12.27959
     Max |         .  12.21014  12.08855  12.08582  12.16458  12.14866  12.17121  12.27959  12.25691
----------------------------------------------------------------------------------------------------

   Stats |  ln_lab..  ln_lab..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..
---------+------------------------------------------------------------------------------------------
       N |     14257     12168         0     16204     17823     16493     15031     19783     18075
    Mean |   -.34946 -.5788914         .  .0147889 -.0033351 -.0233667 -.1101199 -.0212926  .0268062
      SD |  3.582121   3.72447         .  1.769181  1.745758  1.726369    1.8729  2.193894  2.098178
      p1 | -11.30141 -11.46435         . -6.639604 -6.838783 -7.874959 -9.266262 -9.651664 -9.558455
      p5 |  -9.62303 -10.04457         . -1.556182 -1.595054 -1.569783 -1.831702 -1.934488 -1.763737
     p50 |         0         0         . -.0247645 -.0202581 -.0143752 -.0041353  -.028212         0
     p95 |  5.062713  2.871609         .  1.603874  1.593012   1.52025  1.423197  1.930253  1.852036
     p99 |  10.86553  10.70209         .  8.932552   8.61582  7.674894  8.377904  9.559787  9.507677
     Min | -12.25691 -12.22649         . -11.93168 -12.36836 -12.86584 -12.99301 -12.84012 -12.68442
     Max |  12.22649  12.24697         .  13.00512  12.09853  12.99301  12.60555  12.87265    12.917
----------------------------------------------------------------------------------------------------

   Stats |  ln_tot..  ln_tot..  ln_tot..  ln_tot..
---------+----------------------------------------
       N |     15908     16604     14257     12168
    Mean | -.0196572 -.0710895  .0508108 -.0731221
      SD |  2.229446  2.435729  2.372063  2.268246
      p1 | -9.751007 -10.16463  -9.87433 -9.819117
      p5 | -1.997773 -2.369275 -2.040549 -2.126038
     p50 |  .0027389 -.0332006         0 -.0609812
     p95 |  1.846351  2.180855  2.178367  1.997412
     p99 |  9.696384  9.938865  9.998053  9.921954
     Min |   -12.917  -13.0262 -13.03362 -12.57804
     Max |  12.98235  13.03362  13.01796  12.75519
--------------------------------------------------

. 
. save "${PROCESSED}/analysis_ready_processed.dta", replace
file /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Code/Processing/analysis_ready_processed.dta
    saved

. display "04_processing_income: Saved ${PROCESSED}/analysis_ready_processed.dta"
04_processing_income: Saved /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Code/Processing/analysis_rea
> dy_processed.dta

. 
. log close
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Notes/Logs/04_processing_income.log
  log type:  text
 closed on:  10 Feb 2026, 18:19:07
-----------------------------------------------------------------------------------------------------------
