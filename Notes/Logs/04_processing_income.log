--------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Notes/Logs/04_processing_income.log
  log type:  text
 opened on:   4 Feb 2026, 23:01:30

. 
. use "${PROCESSED}/analysis_ready.dta", clear

. 
. * Keep all variables; only modify income series below
. 
. * Require income series to exist
. capture unab _lab_any : labor_income_*

. if _rc {
.     display as error "04: labor_income_* not found in analysis_ready.dta. Run 02_compute_returns_income.do a
> nd 03_prep_controls.do first."
.     log close
.     exit 0
. }

. capture unab _tot_any : total_income_*

. if _rc {
.     display as error "04: total_income_* not found in analysis_ready.dta. Run 02_compute_returns_income.do a
> nd 03_prep_controls.do first."
.     log close
.     exit 0
. }

. 
. * Year list (even years, 2000â€“2022)
. local years "2000 2002 2004 2006 2008 2010 2012 2014 2016 2018 2020 2022"

. 
. * Ensure income stubs exist and build varlists
. local labvars ""

. local totvars ""

. foreach y of local years {
  2.     capture confirm variable labor_income_`y'
  3.     if _rc {
  4.         gen double labor_income_`y' = .
  5.     }
  6.     capture confirm variable total_income_`y'
  7.     if _rc {
  8.         gen double total_income_`y' = .
  9.     }
 10.     local labvars "`labvars' labor_income_`y'"
 11.     local totvars "`totvars' total_income_`y'"
 12. }
(45,234 missing values generated)
(45,234 missing values generated)

. 
. * ---------------------------------------------------------------------
. * Deflate to 2021 dollars using CPI (CPIAUCSL.csv from FRED)
. * ---------------------------------------------------------------------
. display "=== Deflation to 2021 dollars ==="
=== Deflation to 2021 dollars ===

. tempfile cpi

. preserve

. import delimited "${FRED_DATA}/CPIAUCSL.csv", clear
(encoding automatically selected: ISO-8859-1)
(3 vars, 948 obs)

. capture confirm variable date

. if _rc {
.     capture confirm variable DATE
.     if !_rc rename DATE date
. }

. capture confirm variable CPIAUCSL

. if _rc {
.     capture confirm variable cpiaucsl
.     if !_rc rename cpiaucsl CPIAUCSL
. }

. gen year = real(substr(date,1,4))

. collapse (mean) CPIAUCSL, by(year)

. rename CPIAUCSL cpi

. save "`cpi'", replace
(file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_06681.000002 not found)
file /var/folders/17/1rg0y2kj74l9p9g301vbhhkw0000gn/T//S_06681.000002 saved as .dta format

. 
. quietly summarize cpi if year == 2021

. local cpi_2021 = r(mean)

. foreach y of local years {
  2.     quietly summarize cpi if year == `y'
  3.     local cpi_`y' = r(mean)
  4. }

. restore

. 
. display "Tabstat income before deflation"
Tabstat income before deflation

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  lab~2000  lab~2002  lab~2004  lab~2006  lab~2008  lab~2010  lab~2012  lab~2014  lab~2016  lab~2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  22131.29  25651.19  25637.64  30275.06  28811.79  29341.06  30810.18  33649.41  34974.38
      SD |         .  31043.13  48754.37  62517.88    459224  54370.62  40902.93  46785.85  48363.02  84547.03
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  13718.33  15103.31     15600     16296     17460     17784     18528  19817.85     20000
     p95 |         .     67000     78000   76276.1     80000     90000     91500     96000    108800    110000
     p99 |         .    129600    150000    144900    156000    167000    178100    180000  201844.3    210000
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .   1204476   2757948   6993000  6.00e+07   5419560   1053000   2160000   1400000   7352616
--------------------------------------------------------------------------------------------------------------

   Stats |  lab~2020  lab~2022  tot~2000  tot~2002  tot~2004  tot~2006  tot~2008  tot~2010  tot~2012  tot~2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  35827.94  39006.24         .  37026.82  41800.38  46586.64  48611.18  43426.45  44823.46  47629.48
      SD |  58611.73   61978.3         .  84838.98  86267.02  301749.7  466212.2  86623.62  87167.35  129245.5
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .      2566      2256      3300      3600       700      1040      1200
     p50 |     21276     23089         .     20040     22000     22800     23612     23554     23526     24450
     p95 |    110000  123471.6         .  115599.5    134360  133737.7  145023.4  135302.3    142004    145508
     p99 |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |   3150400   3696610         .   7395354   3536773  2.54e+07  6.00e+07   5438860   3663276  1.09e+07
--------------------------------------------------------------------------------------------------------------

   Stats |  tot~2016  tot~2018  tot~2020  tot~2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  51788.16  53714.35  53990.99  59025.53
      SD |  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0
      p5 |       192       100       700       276
     p50 |  25971.05     26000  27750.42   29142.1
     p95 |  162177.6    167500    173600    194000
     p99 |    402260    423990  430294.8  457653.2
     Min |         0         0         0         0
     Max |  1.00e+07   7366716   5731600   4702364
--------------------------------------------------

. 
. local labreal ""

. local totreal ""

. foreach y of local years {
  2.     local cpi_y = `cpi_`y''
  3.     capture drop labor_income_real_`y' total_income_real_`y'
  4.     if "`cpi_y'" != "" {
  5.         gen double labor_income_real_`y' = labor_income_`y' * (`cpi_2021' / `cpi_y')
  6.         gen double total_income_real_`y' = total_income_`y' * (`cpi_2021' / `cpi_y')
  7.     }
  8.     else {
  9.         gen double labor_income_real_`y' = .
 10.         gen double total_income_real_`y' = .
 11.     }
 12.     local labreal "`labreal' labor_income_real_`y'"
 13.     local totreal "`totreal' total_income_real_`y'"
 14. }
(45,234 missing values generated)
(45,234 missing values generated)
(27,069 missing values generated)
(27,069 missing values generated)
(25,105 missing values generated)
(25,105 missing values generated)
(26,765 missing values generated)
(26,765 missing values generated)
(28,017 missing values generated)
(28,017 missing values generated)
(23,200 missing values generated)
(23,200 missing values generated)
(24,680 missing values generated)
(24,680 missing values generated)
(26,487 missing values generated)
(26,487 missing values generated)
(24,322 missing values generated)
(24,322 missing values generated)
(28,088 missing values generated)
(28,088 missing values generated)
(29,511 missing values generated)
(29,511 missing values generated)
(29,378 missing values generated)
(29,378 missing values generated)

. 
. display "Tabstat income after deflation"
Tabstat income after deflation

. tabstat `labreal' `totreal', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~l_2000  l~l_2002  l~l_2004  l~l_2006  l~l_2008  l~l_2010  l~l_2012  l~l_2014  l~l_2016  l~l_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  33340.64  36793.77  34466.35  38111.07  35799.74  34629.65  35268.45  37990.44  37741.75
      SD |         .  46766.26  69932.71  84046.84  578083.8  67557.56   48275.5  53555.82  54602.21  91236.87
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  20666.58  21664.01  20972.09  20513.85  21694.71  20989.49  21209.02   22374.5  21582.51
     p95 |         .    100935  111882.3  102542.9  100706.2  111828.4  107992.5  109891.3    122836  118703.8
     p99 |         .  195241.5  215158.3  194798.5  196377.1  207503.8  210201.7  206046.2  227883.8  226616.4
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .   1814535   3955969   9401143  7.55e+07   6734009   1242798   2472554   1580611   7934397
--------------------------------------------------------------------------------------------------------------

   Stats |  l~l_2020  l~l_2022  t~l_2000  t~l_2002  t~l_2004  t~l_2006  t~l_2008  t~l_2010  t~l_2012  t~l_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  37504.38  36119.35         .  55780.66  59957.99  62629.44  61193.08  53959.02  52902.68  54521.52
      SD |  61354.24  57391.23         .  127809.3  123740.4  405661.7  586880.6  107633.1  102878.9  147947.5
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .  3865.662   3235.98  4436.404  4531.778  869.7766  1227.455  1373.641
     p50 |  22271.53  21380.16         .  30190.13  31556.55  30651.52  29723.43  29266.74  27766.46  27987.94
     p95 |    115147  114333.4         .  174149.9  192724.4  179792.2  182559.4  168118.3  167599.6  166563.2
     p99 |  222568.8  231497.2         .  416775.3  444681.9  452135.4  439330.7  377045.7  389510.5  407175.4
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |   3297811   3423020         .  1.11e+07   5073107  3.41e+07  7.55e+07   6757990   4323565  1.25e+07
--------------------------------------------------------------------------------------------------------------

   Stats |  t~l_2016  t~l_2018  t~l_2020  t~l_2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  58469.23  57964.53  56517.29  54656.99
      SD |  164525.2  146572.3  117526.6  119298.6
      p1 |         0         0         0         0
      p5 |  216.7694  107.9126  732.7539   255.573
     p50 |  29321.51  28057.27   29048.9  26985.26
     p95 |  183099.8  180753.6    181723  179641.9
     p99 |  454154.6  457538.5  450428.9  423781.9
     Min |         0         0         0         0
     Max |  1.13e+07   7949613   5999789   4354338
--------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Winsorize deflated levels (separate toggle on deflated series)
. * ---------------------------------------------------------------------
. display "=== 1% winsorization on deflated levels ==="
=== 1% winsorization on deflated levels ===

. display "Tabstat deflated income before winsorization"
Tabstat deflated income before winsorization

. tabstat `labreal' `totreal', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~l_2000  l~l_2002  l~l_2004  l~l_2006  l~l_2008  l~l_2010  l~l_2012  l~l_2014  l~l_2016  l~l_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  33340.64  36793.77  34466.35  38111.07  35799.74  34629.65  35268.45  37990.44  37741.75
      SD |         .  46766.26  69932.71  84046.84  578083.8  67557.56   48275.5  53555.82  54602.21  91236.87
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  20666.58  21664.01  20972.09  20513.85  21694.71  20989.49  21209.02   22374.5  21582.51
     p95 |         .    100935  111882.3  102542.9  100706.2  111828.4  107992.5  109891.3    122836  118703.8
     p99 |         .  195241.5  215158.3  194798.5  196377.1  207503.8  210201.7  206046.2  227883.8  226616.4
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .   1814535   3955969   9401143  7.55e+07   6734009   1242798   2472554   1580611   7934397
--------------------------------------------------------------------------------------------------------------

   Stats |  l~l_2020  l~l_2022  t~l_2000  t~l_2002  t~l_2004  t~l_2006  t~l_2008  t~l_2010  t~l_2012  t~l_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  37504.38  36119.35         .  55780.66  59957.99  62629.44  61193.08  53959.02  52902.68  54521.52
      SD |  61354.24  57391.23         .  127809.3  123740.4  405661.7  586880.6  107633.1  102878.9  147947.5
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .  3865.662   3235.98  4436.404  4531.778  869.7766  1227.455  1373.641
     p50 |  22271.53  21380.16         .  30190.13  31556.55  30651.52  29723.43  29266.74  27766.46  27987.94
     p95 |    115147  114333.4         .  174149.9  192724.4  179792.2  182559.4  168118.3  167599.6  166563.2
     p99 |  222568.8  231497.2         .  416775.3  444681.9  452135.4  439330.7  377045.7  389510.5  407175.4
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |   3297811   3423020         .  1.11e+07   5073107  3.41e+07  7.55e+07   6757990   4323565  1.25e+07
--------------------------------------------------------------------------------------------------------------

   Stats |  t~l_2016  t~l_2018  t~l_2020  t~l_2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  58469.23  57964.53  56517.29  54656.99
      SD |  164525.2  146572.3  117526.6  119298.6
      p1 |         0         0         0         0
      p5 |  216.7694  107.9126  732.7539   255.573
     p50 |  29321.51  28057.27   29048.9  26985.26
     p95 |  183099.8  180753.6    181723  179641.9
     p99 |  454154.6  457538.5  450428.9  423781.9
     Min |         0         0         0         0
     Max |  1.13e+07   7949613   5999789   4354338
--------------------------------------------------

. 
. local labrealwin ""

. local totrealwin ""

. foreach y of local years {
  2.     quietly summarize labor_income_real_`y', detail
  3.     local p1_lab = r(p1)
  4.     local p99_lab = r(p99)
  5.     capture drop labor_income_real_win_`y'
  6.     gen double labor_income_real_win_`y' = labor_income_real_`y'
  7.     replace labor_income_real_win_`y' = `p1_lab' if labor_income_real_win_`y' < `p1_lab' & !missing(labor
> _income_real_win_`y')
  8.     replace labor_income_real_win_`y' = `p99_lab' if labor_income_real_win_`y' > `p99_lab' & !missing(lab
> or_income_real_win_`y')
  9. 
.     quietly summarize total_income_real_`y', detail
 10.     local p1_tot = r(p1)
 11.     local p99_tot = r(p99)
 12.     capture drop total_income_real_win_`y'
 13.     gen double total_income_real_win_`y' = total_income_real_`y'
 14.     replace total_income_real_win_`y' = `p1_tot' if total_income_real_win_`y' < `p1_tot' & !missing(total
> _income_real_win_`y')
 15.     replace total_income_real_win_`y' = `p99_tot' if total_income_real_win_`y' > `p99_tot' & !missing(tot
> al_income_real_win_`y')
 16. 
.     local labrealwin "`labrealwin' labor_income_real_win_`y'"
 17.     local totrealwin "`totrealwin' total_income_real_win_`y'"
 18. }
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(27,069 missing values generated)
(0 real changes made)
(181 real changes made)
(27,069 missing values generated)
(0 real changes made)
(181 real changes made)
(25,105 missing values generated)
(0 real changes made)
(210 real changes made)
(25,105 missing values generated)
(0 real changes made)
(201 real changes made)
(26,765 missing values generated)
(0 real changes made)
(185 real changes made)
(26,765 missing values generated)
(0 real changes made)
(184 real changes made)
(28,017 missing values generated)
(0 real changes made)
(172 real changes made)
(28,017 missing values generated)
(0 real changes made)
(172 real changes made)
(23,200 missing values generated)
(0 real changes made)
(219 real changes made)
(23,200 missing values generated)
(0 real changes made)
(220 real changes made)
(24,680 missing values generated)
(0 real changes made)
(206 real changes made)
(24,680 missing values generated)
(0 real changes made)
(205 real changes made)
(26,487 missing values generated)
(0 real changes made)
(172 real changes made)
(26,487 missing values generated)
(0 real changes made)
(187 real changes made)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(28,088 missing values generated)
(0 real changes made)
(171 real changes made)
(28,088 missing values generated)
(0 real changes made)
(171 real changes made)
(29,511 missing values generated)
(0 real changes made)
(157 real changes made)
(29,511 missing values generated)
(0 real changes made)
(158 real changes made)
(29,378 missing values generated)
(0 real changes made)
(162 real changes made)
(29,378 missing values generated)
(0 real changes made)
(158 real changes made)

. 
. display "Tabstat deflated income after winsorization"
Tabstat deflated income after winsorization

. tabstat `labrealwin' `totrealwin', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~n_2000  l~n_2002  l~n_2004  l~n_2006  l~n_2008  l~n_2010  l~n_2012  l~n_2014  l~n_2016  l~n_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  32051.03  34677.44   32623.4  32118.26   34179.6  33343.22  33797.75  36431.51  35166.32
      SD |         .  34377.05  38343.38  34869.15  34501.77  37638.02  37227.33  37111.92  41677.96   40663.4
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  20666.58  21664.01  20972.09  20513.85  21694.71  20989.49  21209.02   22374.5  21582.51
     p95 |         .    100935  111882.3  102542.9  100706.2  111828.4  107992.5  109891.3    122836  118703.8
     p99 |         .  195241.5  215158.3  194798.5  196377.1  207503.8  210201.7  206046.2  227883.8  226616.4
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .  195241.5  215158.3  194798.5  196377.1  207503.8  210201.7  206046.2  227883.8  226616.4
--------------------------------------------------------------------------------------------------------------

   Stats |  l~n_2020  l~n_2022  t~n_2000  t~n_2002  t~n_2004  t~n_2006  t~n_2008  t~n_2010  t~n_2012  t~n_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  35752.92  34617.21         .  51878.52  55397.87  53489.83  52958.06  50369.49  49178.34  49727.29
      SD |  39964.27  39802.65         .  66407.29   71841.8  70022.36  69115.31  62362.26   63012.2  63834.37
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .  3865.662   3235.98  4436.404  4531.778  869.7766  1227.455  1373.641
     p50 |  22271.53  21380.16         .  30190.13  31556.55  30651.52  29723.43  29266.74  27766.46  27987.94
     p95 |    115147  114333.4         .  174149.9  192724.4  179792.2  182559.4  168118.3  167599.6  166563.2
     p99 |  222568.8  231497.2         .  416775.3  444681.9  452135.4  439330.7  377045.7  389510.5  407175.4
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |  222568.8  231497.2         .  416775.3  444681.9  452135.4  439330.7  377045.7  389510.5  407175.4
--------------------------------------------------------------------------------------------------------------

   Stats |  t~n_2016  t~n_2018  t~n_2020  t~n_2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  53539.05   52319.7  52701.74  50624.16
      SD |  71987.89   71354.6  70307.45  68371.47
      p1 |         0         0         0         0
      p5 |  216.7694  107.9126  732.7539   255.573
     p50 |  29321.51  28057.27   29048.9  26985.26
     p95 |  183099.8  180753.6    181723  179641.9
     p99 |  454154.6  457538.5  450428.9  423781.9
     Min |         0         0         0         0
     Max |  454154.6  457538.5  450428.9  423781.9
--------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Log income (separate toggle on original series)
. * ---------------------------------------------------------------------
. display "=== Log income (original series) ==="
=== Log income (original series) ===

. display "Tabstat income before logs"
Tabstat income before logs

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016  l~e_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  22131.29  25651.19  25637.64  30275.06  28811.79  29341.06  30810.18  33649.41  34974.38
      SD |         .  31043.13  48754.37  62517.88    459224  54370.62  40902.93  46785.85  48363.02  84547.03
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  13718.33  15103.31     15600     16296     17460     17784     18528  19817.85     20000
     p95 |         .     67000     78000   76276.1     80000     90000     91500     96000    108800    110000
     p99 |         .    129600    150000    144900    156000    167000    178100    180000  201844.3    210000
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .   1204476   2757948   6993000  6.00e+07   5419560   1053000   2160000   1400000   7352616
--------------------------------------------------------------------------------------------------------------

   Stats |  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010  t~e_2012  t~e_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  35827.94  39006.24         .  37026.82  41800.38  46586.64  48611.18  43426.45  44823.46  47629.48
      SD |  58611.73   61978.3         .  84838.98  86267.02  301749.7  466212.2  86623.62  87167.35  129245.5
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .      2566      2256      3300      3600       700      1040      1200
     p50 |     21276     23089         .     20040     22000     22800     23612     23554     23526     24450
     p95 |    110000  123471.6         .  115599.5    134360  133737.7  145023.4  135302.3    142004    145508
     p99 |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |   3150400   3696610         .   7395354   3536773  2.54e+07  6.00e+07   5438860   3663276  1.09e+07
--------------------------------------------------------------------------------------------------------------

   Stats |  t~e_2016  t~e_2018  total_..  t~e_2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  51788.16  53714.35  53990.99  59025.53
      SD |  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0
      p5 |       192       100       700       276
     p50 |  25971.05     26000  27750.42   29142.1
     p95 |  162177.6    167500    173600    194000
     p99 |    402260    423990  430294.8  457653.2
     Min |         0         0         0         0
     Max |  1.00e+07   7366716   5731600   4702364
--------------------------------------------------

. 
. local lablog ""

. local totlog ""

. foreach y of local years {
  2.     capture drop ln_lab_inc_`y' ln_tot_inc_`y'
  3.     gen double ln_lab_inc_`y' = ln(labor_income_`y') if labor_income_`y' > 0
  4.     gen double ln_tot_inc_`y' = ln(total_income_`y') if total_income_`y' > 0
  5.     local lablog "`lablog' ln_lab_inc_`y'"
  6.     local totlog "`totlog' ln_tot_inc_`y'"
  7. }
(45,234 missing values generated)
(45,234 missing values generated)
(28,506 missing values generated)
(27,432 missing values generated)
(26,733 missing values generated)
(25,532 missing values generated)
(28,130 missing values generated)
(27,089 missing values generated)
(29,195 missing values generated)
(28,341 missing values generated)
(25,275 missing values generated)
(23,967 missing values generated)
(26,428 missing values generated)
(25,362 missing values generated)
(28,003 missing values generated)
(27,092 missing values generated)
(26,342 missing values generated)
(25,198 missing values generated)
(29,703 missing values generated)
(28,847 missing values generated)
(30,856 missing values generated)
(30,142 missing values generated)
(30,755 missing values generated)
(30,039 missing values generated)

. 
. display "Tabstat log income after logs"
Tabstat log income after logs

. tabstat `lablog' `totlog', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  ln_la~00  ln_la~02  ln_la~04  ln_la~06  ln_la~08  ln_la~10  ln_la~12  ln_la~14  ln_la~16  ln_la~18
---------+----------------------------------------------------------------------------------------------------
       N |         0     16728     18501     17104     16039     19959     18806     17231     18892     15531
    Mean |         .  9.654445  9.756031  9.777244  9.823333  9.894466  9.895165  9.944104  10.00987  10.01877
      SD |         .  .9512531  .9915846  .9440352   .946715  1.006002  1.031014   1.02167  1.094901  1.082918
      p1 |         .  7.003065  6.984716  7.090077  7.176255  6.802395  6.740519  6.727432  6.421622  6.659294
      p5 |         .   8.34284  8.348538  8.430327  8.476371   8.34284   8.29405  8.414496  8.268732  8.295299
     p50 |         .  9.616005  9.731275   9.74952  9.787403  9.883693  9.889186   9.92329  10.02127  10.02024
     p95 |         .  11.15625  11.28978  11.28978  11.32592  11.44035  11.46688  11.51293  11.64395  11.66479
     p99 |         .  11.78752  11.98293  11.91839  11.99288   12.0624  12.12703  12.10071  12.27639  12.30138
     Min |         .  1.609438   1.94591  4.094345         0  2.995732  2.397895  2.484907  2.302585         0
     Max |         .  14.00156     14.83  15.76042  17.91009  15.50553  13.86715  14.58562  14.15198  15.81057
--------------------------------------------------------------------------------------------------------------

   Stats |  ln_la~20  ln_la~22  ln_to~00  ln_to~02  ln_to~04  ln_to~06  ln_to~08  ln_to~10  ln_to~12  ln_to~14
---------+----------------------------------------------------------------------------------------------------
       N |     14378     14479         0     17802     19702     18145     16893     21267     19872     18142
    Mean |   10.0867  10.15682         .  9.909088    9.9914   10.0362  10.09974  10.07582  10.09054   10.1366
      SD |  1.027354  1.061509         .  1.182881  1.247326  1.201174  1.175945  1.252513  1.229532  1.240228
      p1 |  6.984716  6.803432         .  5.991465   5.63479  6.082219   6.44572  5.733341  5.991465  5.981414
      p5 |  8.517193  8.517193         .   8.34284  8.337109  8.476371  8.548692   8.29405   8.30499  8.455318
     p50 |  10.08581  10.13856         .  9.927228  10.02924  10.05449  10.09278  10.12548  10.11261  10.14201
     p95 |  11.66146  11.77369         .  11.66822  11.81377  11.80932  11.89764  11.84151  11.88034   11.9072
     p99 |  12.32167  12.44902         .  12.53637  12.66931   12.7308  12.76632  12.65172  12.71926  12.79468
     Min |  2.442347  2.484907         .         0         0         0         0         0         0 -1.832581
     Max |  14.96304  15.12293         .  15.81636  15.07873  17.04869  17.91009  15.50908  15.11387  16.20778
--------------------------------------------------------------------------------------------------------------

   Stats |  ln_to~16  ln_to~18  ln_to~20  ln_to~22
---------+----------------------------------------
       N |     20036     16387     15092     15195
    Mean |  10.18113  10.20303  10.27584  10.33174
      SD |  1.325237  1.311782  1.228546  1.276795
      p1 |  5.620401  5.703782   6.49224  5.891644
      p5 |  8.273081  8.318742  8.525161  8.517193
     p50 |  10.23038  10.23287   10.2974  10.33202
     p95 |  12.02934  12.05525  12.08616  12.20408
     p99 |  12.93663  12.96924  12.99237  13.06393
     Min | -2.120264         0         0         0
     Max |  16.12169  15.81248  15.56151  15.36358
--------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Trim top/bottom 1% on levels (separate toggle on original series)
. * ---------------------------------------------------------------------
. display "=== 1% trimming on levels (original series) ==="
=== 1% trimming on levels (original series) ===

. display "Tabstat income before trimming"
Tabstat income before trimming

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016  l~e_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  22131.29  25651.19  25637.64  30275.06  28811.79  29341.06  30810.18  33649.41  34974.38
      SD |         .  31043.13  48754.37  62517.88    459224  54370.62  40902.93  46785.85  48363.02  84547.03
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  13718.33  15103.31     15600     16296     17460     17784     18528  19817.85     20000
     p95 |         .     67000     78000   76276.1     80000     90000     91500     96000    108800    110000
     p99 |         .    129600    150000    144900    156000    167000    178100    180000  201844.3    210000
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .   1204476   2757948   6993000  6.00e+07   5419560   1053000   2160000   1400000   7352616
--------------------------------------------------------------------------------------------------------------

   Stats |  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010  t~e_2012  t~e_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  35827.94  39006.24         .  37026.82  41800.38  46586.64  48611.18  43426.45  44823.46  47629.48
      SD |  58611.73   61978.3         .  84838.98  86267.02  301749.7  466212.2  86623.62  87167.35  129245.5
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .      2566      2256      3300      3600       700      1040      1200
     p50 |     21276     23089         .     20040     22000     22800     23612     23554     23526     24450
     p95 |    110000  123471.6         .  115599.5    134360  133737.7  145023.4  135302.3    142004    145508
     p99 |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |   3150400   3696610         .   7395354   3536773  2.54e+07  6.00e+07   5438860   3663276  1.09e+07
--------------------------------------------------------------------------------------------------------------

   Stats |  t~e_2016  t~e_2018  total_..  t~e_2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  51788.16  53714.35  53990.99  59025.53
      SD |  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0
      p5 |       192       100       700       276
     p50 |  25971.05     26000  27750.42   29142.1
     p95 |  162177.6    167500    173600    194000
     p99 |    402260    423990  430294.8  457653.2
     Min |         0         0         0         0
     Max |  1.00e+07   7366716   5731600   4702364
--------------------------------------------------

. 
. local labtrim ""

. local tottrim ""

. foreach y of local years {
  2.     quietly summarize labor_income_`y', detail
  3.     local p1_lab = r(p1)
  4.     local p99_lab = r(p99)
  5.     capture drop labor_income_trim_`y'
  6.     gen double labor_income_trim_`y' = labor_income_`y'
  7.     replace labor_income_trim_`y' = . if labor_income_trim_`y' < `p1_lab' | labor_income_trim_`y' > `p99_
> lab'
  8. 
.     quietly summarize total_income_`y', detail
  9.     local p1_tot = r(p1)
 10.     local p99_tot = r(p99)
 11.     capture drop total_income_trim_`y'
 12.     gen double total_income_trim_`y' = total_income_`y'
 13.     replace total_income_trim_`y' = . if total_income_trim_`y' < `p1_tot' | total_income_trim_`y' > `p99_
> tot'
 14. 
.     local labtrim "`labtrim' labor_income_trim_`y'"
 15.     local tottrim "`tottrim' total_income_trim_`y'"
 16. }
(45,234 missing values generated)
(0 real changes made)
(45,234 missing values generated)
(0 real changes made)
(27,069 missing values generated)
(181 real changes made, 181 to missing)
(27,069 missing values generated)
(181 real changes made, 181 to missing)
(25,105 missing values generated)
(199 real changes made, 199 to missing)
(25,105 missing values generated)
(201 real changes made, 201 to missing)
(26,765 missing values generated)
(184 real changes made, 184 to missing)
(26,765 missing values generated)
(184 real changes made, 184 to missing)
(28,017 missing values generated)
(172 real changes made, 172 to missing)
(28,017 missing values generated)
(172 real changes made, 172 to missing)
(23,200 missing values generated)
(219 real changes made, 219 to missing)
(23,200 missing values generated)
(220 real changes made, 220 to missing)
(24,680 missing values generated)
(205 real changes made, 205 to missing)
(24,680 missing values generated)
(205 real changes made, 205 to missing)
(26,487 missing values generated)
(172 real changes made, 172 to missing)
(26,487 missing values generated)
(187 real changes made, 187 to missing)
(24,322 missing values generated)
(210 real changes made, 210 to missing)
(24,322 missing values generated)
(209 real changes made, 209 to missing)
(28,088 missing values generated)
(171 real changes made, 171 to missing)
(28,088 missing values generated)
(171 real changes made, 171 to missing)
(29,511 missing values generated)
(157 real changes made, 157 to missing)
(29,511 missing values generated)
(157 real changes made, 157 to missing)
(29,378 missing values generated)
(151 real changes made, 151 to missing)
(29,378 missing values generated)
(158 real changes made, 158 to missing)

. 
. display "Tabstat income after trimming"
Tabstat income after trimming

. tabstat `labtrim' `tottrim', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~m_2000  l~m_2002  l~m_2004  l~m_2006  l~m_2008  l~m_2010  l~m_2012  l~m_2014  l~m_2016  l~m_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     17984     19930     18285     17045     21815     20349     18575     20702     16975
    Mean |         .  20185.02  22919.42  23052.85   24197.7  26107.53  26741.48  28132.03  30548.45   30800.6
      SD |         .  20165.93  23707.47  23056.26  24191.21  27008.57   27864.3  29141.24  32892.43  33375.75
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .     13512     15000     15432     16068     17180     17502     18200     19500  19693.47
     p95 |         .     62000     72000  70817.36     75000     82976     85000  89911.44    100000    100000
     p99 |         .     99200    116000  112103.7    119900  129694.6    135000  140836.9    160000    160000
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .    129600    150000    144900    156000    167000    178100    180000    201400    210000
--------------------------------------------------------------------------------------------------------------

   Stats |  l~m_2020  l~m_2022  t~m_2000  t~m_2002  t~m_2004  t~m_2006  t~m_2008  t~m_2010  t~m_2012  t~m_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15566     15705         0     17984     19928     18285     17045     21814     20349     18560
    Mean |  32354.76  35339.79         .  31998.83  35883.89  36804.23  38972.14  37886.07  38762.93   40295.1
      SD |  33878.48  37769.52         .  36962.42  42230.42  42970.31  45657.93  42897.65  45088.36  46353.95
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .      2500      2200      3230      3600       630      1000      1134
     p50 |  20952.45     22836         .     19822  21715.03  22435.97     23220     23160  23087.28  24050.41
     p95 |    102000    114000         .  104904.3  120099.4  119973.9    129580  123735.7    129992    131198
     p99 |    166000    180200         .  195815.4  220317.9    224800    237200    220500  233091.7    231600
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
--------------------------------------------------------------------------------------------------------------

   Stats |  t~m_2016  t~m_2018  t~m_2020  t~m_2022
---------+----------------------------------------
       N |     20703     16975     15566     15698
    Mean |  43839.19   44700.7  46513.79  50614.36
      SD |  53128.81  54602.35  55549.83  62093.43
      p1 |         0         0         0         0
      p5 |       160        90       600       240
     p50 |     25456     25540   27432.7     28800
     p95 |  148361.7    152320    157000    174040
     p99 |    273600    281000    288732  322031.1
     Min |         0         0         0         0
     Max |    402260    423990  430294.8  457653.2
--------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Winsorize top/bottom 1% on levels (separate toggle on original series)
. * ---------------------------------------------------------------------
. display "=== 1% winsorization on levels (original series) ==="
=== 1% winsorization on levels (original series) ===

. display "Tabstat income before winsorization"
Tabstat income before winsorization

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016  l~e_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  22131.29  25651.19  25637.64  30275.06  28811.79  29341.06  30810.18  33649.41  34974.38
      SD |         .  31043.13  48754.37  62517.88    459224  54370.62  40902.93  46785.85  48363.02  84547.03
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  13718.33  15103.31     15600     16296     17460     17784     18528  19817.85     20000
     p95 |         .     67000     78000   76276.1     80000     90000     91500     96000    108800    110000
     p99 |         .    129600    150000    144900    156000    167000    178100    180000  201844.3    210000
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .   1204476   2757948   6993000  6.00e+07   5419560   1053000   2160000   1400000   7352616
--------------------------------------------------------------------------------------------------------------

   Stats |  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010  t~e_2012  t~e_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  35827.94  39006.24         .  37026.82  41800.38  46586.64  48611.18  43426.45  44823.46  47629.48
      SD |  58611.73   61978.3         .  84838.98  86267.02  301749.7  466212.2  86623.62  87167.35  129245.5
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .      2566      2256      3300      3600       700      1040      1200
     p50 |     21276     23089         .     20040     22000     22800     23612     23554     23526     24450
     p95 |    110000  123471.6         .  115599.5    134360  133737.7  145023.4  135302.3    142004    145508
     p99 |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |   3150400   3696610         .   7395354   3536773  2.54e+07  6.00e+07   5438860   3663276  1.09e+07
--------------------------------------------------------------------------------------------------------------

   Stats |  t~e_2016  t~e_2018  total_..  t~e_2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  51788.16  53714.35  53990.99  59025.53
      SD |  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0
      p5 |       192       100       700       276
     p50 |  25971.05     26000  27750.42   29142.1
     p95 |  162177.6    167500    173600    194000
     p99 |    402260    423990  430294.8  457653.2
     Min |         0         0         0         0
     Max |  1.00e+07   7366716   5731600   4702364
--------------------------------------------------

. 
. local labwin ""

. local totwin ""

. foreach y of local years {
  2.     quietly summarize labor_income_`y', detail
  3.     local p1_lab = r(p1)
  4.     local p99_lab = r(p99)
  5.     capture drop labor_income_win_`y'
  6.     gen double labor_income_win_`y' = labor_income_`y'
  7.     replace labor_income_win_`y' = `p1_lab' if labor_income_win_`y' < `p1_lab' & !missing(labor_income_wi
> n_`y')
  8.     replace labor_income_win_`y' = `p99_lab' if labor_income_win_`y' > `p99_lab' & !missing(labor_income_
> win_`y')
  9. 
.     quietly summarize total_income_`y', detail
 10.     local p1_tot = r(p1)
 11.     local p99_tot = r(p99)
 12.     capture drop total_income_win_`y'
 13.     gen double total_income_win_`y' = total_income_`y'
 14.     replace total_income_win_`y' = `p1_tot' if total_income_win_`y' < `p1_tot' & !missing(total_income_wi
> n_`y')
 15.     replace total_income_win_`y' = `p99_tot' if total_income_win_`y' > `p99_tot' & !missing(total_income_
> win_`y')
 16. 
.     local labwin "`labwin' labor_income_win_`y'"
 17.     local totwin "`totwin' total_income_win_`y'"
 18. }
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(27,069 missing values generated)
(0 real changes made)
(181 real changes made)
(27,069 missing values generated)
(0 real changes made)
(181 real changes made)
(25,105 missing values generated)
(0 real changes made)
(199 real changes made)
(25,105 missing values generated)
(0 real changes made)
(201 real changes made)
(26,765 missing values generated)
(0 real changes made)
(184 real changes made)
(26,765 missing values generated)
(0 real changes made)
(184 real changes made)
(28,017 missing values generated)
(0 real changes made)
(172 real changes made)
(28,017 missing values generated)
(0 real changes made)
(172 real changes made)
(23,200 missing values generated)
(0 real changes made)
(219 real changes made)
(23,200 missing values generated)
(0 real changes made)
(220 real changes made)
(24,680 missing values generated)
(0 real changes made)
(205 real changes made)
(24,680 missing values generated)
(0 real changes made)
(205 real changes made)
(26,487 missing values generated)
(0 real changes made)
(172 real changes made)
(26,487 missing values generated)
(0 real changes made)
(187 real changes made)
(24,322 missing values generated)
(0 real changes made)
(210 real changes made)
(24,322 missing values generated)
(0 real changes made)
(209 real changes made)
(28,088 missing values generated)
(0 real changes made)
(171 real changes made)
(28,088 missing values generated)
(0 real changes made)
(171 real changes made)
(29,511 missing values generated)
(0 real changes made)
(157 real changes made)
(29,511 missing values generated)
(0 real changes made)
(157 real changes made)
(29,378 missing values generated)
(0 real changes made)
(151 real changes made)
(29,378 missing values generated)
(0 real changes made)
(158 real changes made)

. 
. display "Tabstat income after winsorization"
Tabstat income after winsorization

. tabstat `labwin' `totwin', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..  labor_..
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  21275.25  24175.77  24266.77  25514.42  27507.89  28251.09  29525.39  32268.62  32587.79
      SD |         .  22819.25  26731.52  25937.27  27407.87  30291.25  31542.03  32420.62  36915.57   37681.8
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  13718.33  15103.31     15600     16296     17460     17784     18528  19817.85     20000
     p95 |         .     67000     78000   76276.1     80000     90000     91500     96000    108800    110000
     p99 |         .    129600    150000    144900    156000    167000    178100    180000  201844.3    210000
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .    129600    150000    144900    156000    167000    178100    180000  201844.3    210000
--------------------------------------------------------------------------------------------------------------

   Stats |  labor_..  labor_..  total_..  total_..  total_..  total_..  total_..  total_..  total_..  total_..
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  34154.78  37384.04         .  34436.61  38621.25  39788.18  42069.36  40537.59   41667.9  43441.29
      SD |  38177.88  42983.94         .  44080.71  50085.32  52085.84  54904.52  50189.42  53389.06   55765.1
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .      2566      2256      3300      3600       700      1040      1200
     p50 |     21276     23089         .     20040     22000     22800     23612     23554     23526     24450
     p95 |    110000  123471.6         .  115599.5    134360  133737.7  145023.4  135302.3    142004    145508
     p99 |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
--------------------------------------------------------------------------------------------------------------

   Stats |  total_..  total_..  total_..  total_..
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  47421.34  48483.41  50345.99  54670.37
      SD |   63762.1   66122.6  67164.72  73836.16
      p1 |         0         0         0         0
      p5 |       192       100       700       276
     p50 |  25971.05     26000  27750.42   29142.1
     p95 |  162177.6    167500    173600    194000
     p99 |    402260    423990  430294.8  457653.2
     Min |         0         0         0         0
     Max |    402260    423990  430294.8  457653.2
--------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Final toggle (apply all: deflate -> log -> winsorize)
. * ---------------------------------------------------------------------
. display "=== Final toggle: deflate->log->winsorize ==="
=== Final toggle: deflate->log->winsorize ===

. display "Tabstat income before final toggle (original series)"
Tabstat income before final toggle (original series)

. tabstat `labvars' `totvars', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  l~e_2000  l~e_2002  l~e_2004  l~e_2006  l~e_2008  l~e_2010  l~e_2012  l~e_2014  l~e_2016  l~e_2018
---------+----------------------------------------------------------------------------------------------------
       N |         0     18165     20129     18469     17217     22034     20554     18747     20912     17146
    Mean |         .  22131.29  25651.19  25637.64  30275.06  28811.79  29341.06  30810.18  33649.41  34974.38
      SD |         .  31043.13  48754.37  62517.88    459224  54370.62  40902.93  46785.85  48363.02  84547.03
      p1 |         .         0         0         0         0         0         0         0         0         0
      p5 |         .         0         0         0         0         0         0         0         0         0
     p50 |         .  13718.33  15103.31     15600     16296     17460     17784     18528  19817.85     20000
     p95 |         .     67000     78000   76276.1     80000     90000     91500     96000    108800    110000
     p99 |         .    129600    150000    144900    156000    167000    178100    180000  201844.3    210000
     Min |         .         0         0         0         0         0         0         0         0         0
     Max |         .   1204476   2757948   6993000  6.00e+07   5419560   1053000   2160000   1400000   7352616
--------------------------------------------------------------------------------------------------------------

   Stats |  l~e_2020  l~e_2022  t~e_2000  t~e_2002  t~e_2004  t~e_2006  t~e_2008  t~e_2010  t~e_2012  t~e_2014
---------+----------------------------------------------------------------------------------------------------
       N |     15723     15856         0     18165     20129     18469     17217     22034     20554     18747
    Mean |  35827.94  39006.24         .  37026.82  41800.38  46586.64  48611.18  43426.45  44823.46  47629.48
      SD |  58611.73   61978.3         .  84838.98  86267.02  301749.7  466212.2  86623.62  87167.35  129245.5
      p1 |         0         0         .         0         0         0         0         0         0         0
      p5 |         0         0         .      2566      2256      3300      3600       700      1040      1200
     p50 |     21276     23089         .     20040     22000     22800     23612     23554     23526     24450
     p95 |    110000  123471.6         .  115599.5    134360  133737.7  145023.4  135302.3    142004    145508
     p99 |    212620    250000         .  276652.6    310015    336319    349000    303448    330025  355704.5
     Min |         0         0         .         0         0         0         0         0         0         0
     Max |   3150400   3696610         .   7395354   3536773  2.54e+07  6.00e+07   5438860   3663276  1.09e+07
--------------------------------------------------------------------------------------------------------------

   Stats |  t~e_2016  t~e_2018  total_..  t~e_2022
---------+----------------------------------------
       N |     20912     17146     15723     15856
    Mean |  51788.16  53714.35  53990.99  59025.53
      SD |  145725.5  135825.1  112273.2  128833.8
      p1 |         0         0         0         0
      p5 |       192       100       700       276
     p50 |  25971.05     26000  27750.42   29142.1
     p95 |  162177.6    167500    173600    194000
     p99 |    402260    423990  430294.8  457653.2
     Min |         0         0         0         0
     Max |  1.00e+07   7366716   5731600   4702364
--------------------------------------------------

. 
. local labfinal ""

. local totfinal ""

. foreach y of local years {
  2.     * Start from deflated series
.     capture confirm variable labor_income_real_`y'
  3.     if _rc {
  4.         gen double labor_income_real_`y' = labor_income_`y' * (`cpi_2021' / `cpi_`y'')
  5.     }
  6.     capture confirm variable total_income_real_`y'
  7.     if _rc {
  8.         gen double total_income_real_`y' = total_income_`y' * (`cpi_2021' / `cpi_`y'')
  9.     }
 10. 
.     * Log (positive only)
.     capture drop ln_lab_inc_final_`y' ln_tot_inc_final_`y'
 11.     gen double ln_lab_inc_final_`y' = ln(labor_income_real_`y') if labor_income_real_`y' > 0
 12.     gen double ln_tot_inc_final_`y' = ln(total_income_real_`y') if total_income_real_`y' > 0
 13. 
.     * Winsorize on log values (p1/p99)
.     quietly summarize ln_lab_inc_final_`y', detail
 14.     local p1_lab = r(p1)
 15.     local p99_lab = r(p99)
 16.     replace ln_lab_inc_final_`y' = `p1_lab' if ln_lab_inc_final_`y' < `p1_lab' & !missing(ln_lab_inc_fina
> l_`y')
 17.     replace ln_lab_inc_final_`y' = `p99_lab' if ln_lab_inc_final_`y' > `p99_lab' & !missing(ln_lab_inc_fi
> nal_`y')
 18. 
.     quietly summarize ln_tot_inc_final_`y', detail
 19.     local p1_tot = r(p1)
 20.     local p99_tot = r(p99)
 21.     replace ln_tot_inc_final_`y' = `p1_tot' if ln_tot_inc_final_`y' < `p1_tot' & !missing(ln_tot_inc_fina
> l_`y')
 22.     replace ln_tot_inc_final_`y' = `p99_tot' if ln_tot_inc_final_`y' > `p99_tot' & !missing(ln_tot_inc_fi
> nal_`y')
 23. 
.     local labfinal "`labfinal' ln_lab_inc_final_`y'"
 24.     local totfinal "`totfinal' ln_tot_inc_final_`y'"
 25. }
(45,234 missing values generated)
(45,234 missing values generated)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(28,506 missing values generated)
(27,432 missing values generated)
(167 real changes made)
(168 real changes made)
(175 real changes made)
(179 real changes made)
(26,733 missing values generated)
(25,532 missing values generated)
(185 real changes made)
(185 real changes made)
(197 real changes made)
(198 real changes made)
(28,130 missing values generated)
(27,089 missing values generated)
(155 real changes made)
(165 real changes made)
(181 real changes made)
(182 real changes made)
(29,195 missing values generated)
(28,341 missing values generated)
(160 real changes made)
(161 real changes made)
(168 real changes made)
(169 real changes made)
(25,275 missing values generated)
(23,967 missing values generated)
(195 real changes made)
(200 real changes made)
(212 real changes made)
(212 real changes made)
(26,428 missing values generated)
(25,362 missing values generated)
(188 real changes made)
(188 real changes made)
(192 real changes made)
(198 real changes made)
(28,003 missing values generated)
(27,092 missing values generated)
(172 real changes made)
(172 real changes made)
(181 real changes made)
(182 real changes made)
(26,342 missing values generated)
(25,198 missing values generated)
(188 real changes made)
(189 real changes made)
(200 real changes made)
(200 real changes made)
(29,703 missing values generated)
(28,847 missing values generated)
(155 real changes made)
(151 real changes made)
(160 real changes made)
(163 real changes made)
(30,856 missing values generated)
(30,142 missing values generated)
(143 real changes made)
(144 real changes made)
(150 real changes made)
(151 real changes made)
(30,755 missing values generated)
(30,039 missing values generated)
(144 real changes made)
(145 real changes made)
(151 real changes made)
(151 real changes made)

. 
. display "Tabstat income after final toggle (final log series)"
Tabstat income after final toggle (final log series)

. tabstat `labfinal' `totfinal', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..
---------+----------------------------------------------------------------------------------------------------
       N |         0     16728     18501     17104     16039     19959     18806     17231     18892     15531
    Mean |         .  10.07125  10.12317  10.07637  10.05808   10.1153  10.06623  10.08386  10.13658  10.10033
      SD |         .  .8914661  .9340828  .9042876  .8953294  .9656217  .9843282  .9747867  1.044452  1.026206
      p1 |         .   7.41285  7.345455  7.385998  7.406435  7.019551  6.906242  6.862575  6.542961  6.735445
      p5 |         .  8.752624  8.709276  8.726249  8.706552  8.559996  8.459772  8.549639  8.390071   8.37145
     p50 |         .  10.02579  10.09201  10.04544  10.01758  10.10085  10.05491  10.05843  10.14261  10.09639
     p95 |         .  11.56604  11.65052   11.5857   11.5561  11.65751   11.6326  11.64807  11.76529  11.74094
     p99 |         .  12.19731  12.34367  12.21431  12.22306  12.27956  12.29275  12.23586  12.39773  12.37753
     Min |         .   7.41285  7.345455  7.385998  7.406435  7.019551  6.906242  6.862575  6.542961  6.735445
     Max |         .  12.19731  12.34367  12.21431  12.22306  12.27956  12.29275  12.23586  12.39773  12.37753
--------------------------------------------------------------------------------------------------------------

   Stats |  ln_lab..  ln_lab..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..
---------+----------------------------------------------------------------------------------------------------
       N |     14378     14479         0     17802     19702     18145     16893     21267     19872     18142
    Mean |  10.13722  10.08544         .  10.33048  10.36496  10.34424  10.34265   10.3073  10.26765  10.28539
      SD |  .9805907  1.012199         .  1.091179  1.146773  1.101014  1.077016  1.145028  1.135624  1.129346
      p1 |  7.030446  6.726539         .  6.401249  5.995528  6.378141    6.6759  5.950497  6.157187  6.116558
      p5 |  8.562923    8.4403         .  8.752624  8.697848  8.772293  8.778872  8.511206  8.470712  8.590461
     p50 |  10.13154  10.06167         .  10.33701  10.38998  10.35041  10.32297  10.34264  10.27834  10.27715
     p95 |  11.70719   11.6968         .    12.078  12.17451  12.10524  12.12782  12.05867  12.04606  12.04234
     p99 |  12.36739  12.37213         .  12.94615  13.03005  13.02672   12.9965  12.86888  12.88498  12.92982
     Min |  7.030446  6.726539         .  6.401249  5.995528  6.378141    6.6759  5.950497  6.157187  6.116558
     Max |  12.36739  12.37213         .  12.94615  13.03005  13.02672   12.9965  12.86888  12.88498  12.92982
--------------------------------------------------------------------------------------------------------------

   Stats |  ln_tot..  ln_tot..  ln_tot..  ln_tot..
---------+----------------------------------------
       N |     20036     16387     15092     15195
    Mean |  10.31845  10.29316   10.3371  10.26754
      SD |  1.207728  1.198123  1.122652  1.180377
      p1 |   5.74174  5.779934  6.537969  5.814751
      p5 |   8.39442  8.394893  8.570891    8.4403
     p50 |  10.35171  10.30902  10.34313  10.25513
     p95 |  12.15067   12.1314  12.13189  12.12719
     p99 |  13.05797  13.04539   13.0381  12.98704
     Min |   5.74174  5.779934  6.537969  5.814751
     Max |  13.05797  13.04539   13.0381  12.98704
--------------------------------------------------

. 
. * ---------------------------------------------------------------------
. * Income growth from final log series (two-year differences)
. * ---------------------------------------------------------------------
. display "=== Income growth from final log series ==="
=== Income growth from final log series ===

. local labgrowth ""

. local totgrowth ""

. foreach y of local years {
  2.     if `y' > 2000 {
  3.         local yprev = `y' - 2
  4.         capture drop ln_lab_inc_final_growth_`y' ln_tot_inc_final_growth_`y'
  5.         gen double ln_lab_inc_final_growth_`y' = ln_lab_inc_final_`y' - ln_lab_inc_final_`yprev' ///
>             if !missing(ln_lab_inc_final_`y') & !missing(ln_lab_inc_final_`yprev')
  6.         gen double ln_tot_inc_final_growth_`y' = ln_tot_inc_final_`y' - ln_tot_inc_final_`yprev' ///
>             if !missing(ln_tot_inc_final_`y') & !missing(ln_tot_inc_final_`yprev')
  7.         local labgrowth "`labgrowth' ln_lab_inc_final_growth_`y'"
  8.         local totgrowth "`totgrowth' ln_tot_inc_final_growth_`y'"
  9.     }
 10. }
(45,234 missing values generated)
(45,234 missing values generated)
(30,743 missing values generated)
(29,527 missing values generated)
(29,358 missing values generated)
(27,959 missing values generated)
(30,435 missing values generated)
(29,237 missing values generated)
(31,728 missing values generated)
(30,727 missing values generated)
(28,028 missing values generated)
(26,528 missing values generated)
(29,326 missing values generated)
(28,106 missing values generated)
(31,249 missing values generated)
(30,211 missing values generated)
(30,928 missing values generated)
(29,766 missing values generated)
(32,837 missing values generated)
(31,926 missing values generated)
(34,528 missing values generated)
(33,790 missing values generated)

. display "Tabstat income growth (final log series)"
Tabstat income growth (final log series)

. tabstat `labgrowth' `totgrowth', statistics(n mean sd p1 p5 p50 p95 p99 min max)

   Stats |  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..  ln_lab..
---------+----------------------------------------------------------------------------------------------------
       N |         0     14491     15876     14799     13506     17206     15908     13985     14306     12397
    Mean |         . -.0119203 -.0431717 -.0216794 -.0118418 -.0445757  .0153826  .0030239 -.0441773  .0023344
      SD |         .  .6650972  .6712725  .6518146  .7007993  .7668774  .7691975  .7793361  .8242216  .8027683
      p1 |         . -2.150928 -2.320485 -2.058171 -2.357574  -2.53634 -2.537663 -2.636128 -2.738285  -2.58866
      p5 |         . -1.075013 -1.143321 -1.103729 -1.188573 -1.262524 -1.166982 -1.199428 -1.344471 -1.271904
     p50 |         . -.0230283 -.0241977  -.016767  .0367647 -.0256612 -.0002735  .0051326 -.0371786  .0024662
     p95 |         .  1.041339  .9850051  1.031418  1.030888   1.14652  1.211086  1.175099  1.223783  1.241573
     p99 |         .  2.148179  2.083062  2.103313  2.034964  2.390913  2.454328  2.436994  2.726181   2.58145
     Min |         . -4.354112 -4.536456 -4.584733 -5.193559  -5.05733 -5.430177 -5.222076 -5.662283 -4.643843
     Max |         .  4.275761  3.985356  4.251747  4.674303  4.940668  4.980056  4.949136  5.834573  4.843013
--------------------------------------------------------------------------------------------------------------

   Stats |  ln_lab..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..  ln_tot..
---------+----------------------------------------------------------------------------------------------------
       N |     10706         0     15707     17275     15997     14507     18706     17128     15023     15468
    Mean | -.0772451         . -.0341904 -.0295765 -.0225443 -.0821397 -.0479558  .0089779 -.0109264 -.0402934
      SD |  .8222124         .    .90757  .9021983  .8645663  .9196311   .959586  .9139085  .9538031  1.004548
      p1 | -2.790851         . -2.927442 -2.736664 -2.704798 -3.074015 -3.130587 -2.930167 -3.172961 -3.281307
      p5 | -1.415992         . -1.371335 -1.389236  -1.34834  -1.54242 -1.497045 -1.375947 -1.474992 -1.548862
     p50 | -.0633753         . -.0276421 -.0219873 -.0151958 -.0055339 -.0324708 -.0000509  .0037397 -.0361586
     p95 |  1.177877         .  1.337248  1.316816  1.295843  1.219119  1.418742   1.39454   1.37249  1.481554
     p99 |  2.544745         .  2.885679  2.996703  2.765785  2.629835  3.068891  2.911552  2.974359  3.247155
     Min | -5.284841         . -6.177522 -6.472375 -5.698322 -7.046001 -6.711689 -6.445858 -6.411553 -7.015934
     Max |   5.34168         .  6.628801  6.962202  5.958491  6.157117  6.934482  6.216496  6.941412  6.702273
--------------------------------------------------------------------------------------------------------------

   Stats |  ln_tot..  ln_tot..
---------+--------------------
       N |     13308     11444
    Mean | -.0011244 -.0932352
      SD |  .9654691  .9818397
      p1 | -2.883053 -3.239299
      p5 | -1.508524 -1.648585
     p50 |  .0011931 -.0657562
     p95 |  1.472878  1.395844
     p99 |  3.197782  2.946326
     Min | -5.964835 -7.223347
     Max |  7.258164  5.913485
------------------------------

. 
. save "${PROCESSED}/analysis_ready_processed.dta", replace
file /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Code/Processing/analysis_ready_processed.dta saved

. display "04_processing_income: Saved ${PROCESSED}/analysis_ready_processed.dta"
04_processing_income: Saved /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Code/Processing/analysis_ready_
> processed.dta

. 
. log close
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Notes/Logs/04_processing_income.log
  log type:  text
 closed on:   4 Feb 2026, 23:01:38
--------------------------------------------------------------------------------------------------------------
