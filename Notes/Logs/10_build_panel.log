-------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Notes/Logs/10_build_panel.log
  log type:  text
 opened on:  11 Feb 2026, 23:11:33

. 
. * ----------------------------------------------------------------------
. * Load processed wide dataset
. * ----------------------------------------------------------------------
. use "${PROCESSED}/analysis_ready_processed.dta", clear

. 
. capture confirm variable hhidpn

. if _rc {
.     display as error "10_build_panel: hhidpn (panel id) not found in analysis_ready_processed.d
> ta."
.     log close
.     exit 0
. }

. 
. * Weight (optional)
. local wtvar "RwWTRESP"

. capture confirm variable `wtvar'

. local has_wt = (_rc == 0)

. local wopt ""

. if `has_wt' local wopt "[aw=`wtvar']"

. 
. * Year list for returns/income panel (even years where returns exist)
. local years "2002 2004 2006 2008 2010 2012 2014 2016 2018 2020 2022"

. 
. display "=== 10_build_panel: Defining panel variable groups from analysis_ready_processed.dta =
> =="
=== 10_build_panel: Defining panel variable groups from analysis_ready_processed.dta ===

. 
. * ----------------------------------------------------------------------
. * Required: raw returns (r1_annual_*, r4_annual_*, r5_annual_*) for panel baseline (14)
. * Fail loudly if missing; do NOT silently continue.
. * ----------------------------------------------------------------------
. foreach stub in r1_annual r4_annual r5_annual {
  2.     capture unab rawlist : `stub'_*
  3.     if _rc {
  4.         display as error "10_build_panel: `stub'_* not found in analysis_ready_processed.dta
> ."
  5.         display as error "  Run 02_compute_returns_income.do, 03_prep_controls.do, 04_proces
> sing_income.do, 05_processing_returns.do in order."
  6.         log close
  7.         exit 198
  8.     }
  9.     local n : word count `rawlist'
 10.     display "10_build_panel: `stub'_* present (`n' vars)"
 11. }
10_build_panel: r1_annual_* present (47 vars)
10_build_panel: r4_annual_* present (47 vars)
10_build_panel: r5_annual_* present (47 vars)

. 
. * ----------------------------------------------------------------------
. * Time-varying groups: stubs for reshape + explicit varlists for keep
. * ----------------------------------------------------------------------
. 
. * Returns: raw (r*_annual), win (r*_annual_win), w5 (r*_annual_w5) — raw required for 14
. local ret_stubs ""

. local ret_vars  ""

. foreach s in r1_annual r1_annual_win r1_annual_w5 r4_annual r4_annual_win r4_annual_w5 r5_annua
> l r5_annual_win r5_annual_w5 {
  2.     capture unab tmp : `s'_*
  3.     if !_rc {
  4.         local ret_stubs "`ret_stubs' `s'_"
  5.         local ret_vars  "`ret_vars' `tmp'"
  6.     }
  7. }

. 
. * Deflated + winsorized income (levels and any final specs)
. local inc_stubs ""

. local inc_vars  ""

. foreach s in labor_income_real_win total_income_real_win {
  2.     capture unab tmp : `s'_*
  3.     if !_rc {
  4.         local inc_stubs "`inc_stubs' `s'_"
  5.         local inc_vars  "`inc_vars' `tmp'"
  6.     }
  7. }

. * Include any final log/residualized income series if present
. foreach s in ln_lab_inc_final ln_tot_inc_final ln_lab_inc_final_resid ln_tot_inc_final_resid {
  2.     capture unab tmp : `s'_*
  3.     if !_rc {
  4.         local inc_stubs "`inc_stubs' `s'_"
  5.         local inc_vars  "`inc_vars' `tmp'"
  6.     }
  7. }

. 
. * Wealth (levels)
. local wealth_stubs ""

. local wealth_vars  ""

. foreach s in wealth_core wealth_ira wealth_coreira wealth_total {
  2.     capture unab tmp : `s'_*
  3.     if !_rc {
  4.         local wealth_stubs "`wealth_stubs' `s'_"
  5.         local wealth_vars  "`wealth_vars' `tmp'"
  6.     }
  7. }

. * Wealth deciles for panel regressions (14): r1->wealth_core_d*, r4->wealth_coreira_d*, r5->wea
> lth_d*
. forvalues d = 2/10 {
  2.     foreach s in wealth_core_d`d' wealth_coreira_d`d' wealth_d`d' {
  3.         capture unab tmp : `s'_*
  4.         if !_rc {
  5.             local wealth_stubs "`wealth_stubs' `s'_"
  6.             local wealth_vars  "`wealth_vars' `tmp'"
  7.         }
  8.     }
  9. }

. * Leverage ratios for panel regressions (15)
. foreach s in leverage_long leverage_other {
  2.     capture unab tmp : `s'_*
  3.     if !_rc {
  4.         local wealth_stubs "`wealth_stubs' `s'_"
  5.         local wealth_vars  "`wealth_vars' `tmp'"
  6.     }
  7. }

. 
. * Shares for panel regressions (15): core/gross, ira/gross, res/gross (share_core, share_m3_ira
> , share_residential)
. * share_core_coreira and share_ira_coreira are created post-reshape from wealth_core, wealth_ir
> a
. local share_stubs ""

. local share_vars  ""

. foreach s in share_core share_m3_ira share_residential {
  2.     capture unab tmp : `s'_*
  3.     if !_rc {
  4.         local share_stubs "`share_stubs' `s'_"
  5.         local share_vars  "`share_vars' `tmp'"
  6.     }
  7. }

. 
. * Core wave-specific controls
. local ctrl_stubs ""

. local ctrl_vars  ""

. * censreg (census region) created in 03; region_pop_group, region_pop3_group, regional_trust no
>  longer cause ambiguity
. foreach s in age age_bin married inlbrf censreg hometown_size region_pop_group region_pop3_grou
> p townsize_trust pop_trust regional_trust {
  2.     capture unab tmp : `s'_*
  3.     if !_rc {
  4.         local ctrl_stubs "`ctrl_stubs' `s'_"
  5.         local ctrl_vars  "`ctrl_vars' `tmp'"
  6.     }
  7. }

. 
. * ----------------------------------------------------------------------
. * Time-invariant (or single-wave) controls: trust, finlit, demographics, 2020-only controls
. * ----------------------------------------------------------------------
. local tinv_vars ""

. foreach v in trust_others_2020 trust_social_security_2020 trust_medicare_2020 trust_banks_2020 
> ///
>              trust_advisors_2020 trust_mutual_funds_2020 trust_insurance_2020 trust_media_2020 
> ///
>              interest_2020 inflation_2020 risk_div_2020 ///
>              educ_yrs gender immigrant born_us race_eth ///
>              depression_2020 health_cond_2020 medicare_2020 medicaid_2020 life_ins_2020 beq_any
> _2020 ///
>              num_divorce_2020 num_widow_2020 population_2020 population_3bin_2020 {
  2.     capture confirm variable `v'
  3.     if !_rc local tinv_vars "`tinv_vars' `v'"
  4. }

. 
. display "Returns stubs: `ret_stubs'"
Returns stubs:  r1_annual_ r1_annual_win_ r1_annual_w5_ r4_annual_ r4_annual_win_ r4_annual_w5_ r
> 5_annual_ r5_annual_win_ r5_annual_w5_

. display "Income stubs:  `inc_stubs'"
Income stubs:   labor_income_real_win_ total_income_real_win_ ln_lab_inc_final_ ln_tot_inc_final_

. display "Wealth stubs:  `wealth_stubs'"
Wealth stubs:   wealth_core_ wealth_ira_ wealth_coreira_ wealth_total_ wealth_core_d2_ wealth_cor
> eira_d2_ wealth_d2_ wealth_core_d3_ wealth_coreira_d3_ wealth_d3_ wealth_core_d4_ wealth_coreir
> a_d4_ wealth_d4_ wealth_core_d5_ wealth_coreira_d5_ wealth_d5_ wealth_core_d6_ wealth_coreira_d
> 6_ wealth_d6_ wealth_core_d7_ wealth_coreira_d7_ wealth_d7_ wealth_core_d8_ wealth_coreira_d8_ 
> wealth_d8_ wealth_core_d9_ wealth_coreira_d9_ wealth_d9_ wealth_core_d10_ wealth_coreira_d10_ w
> ealth_d10_ leverage_long_ leverage_other_

. display "Share stubs:   `share_stubs'"
Share stubs:    share_core_ share_m3_ira_ share_residential_

. display "Control stubs: `ctrl_stubs'"
Control stubs:  age_ age_bin_ married_ inlbrf_ censreg_ hometown_size_ region_pop_group_ region_p
> op3_group_ townsize_trust_ pop_trust_ regional_trust_

. display "Time-invariant vars: `tinv_vars'"
Time-invariant vars:  trust_others_2020 trust_social_security_2020 trust_medicare_2020 trust_bank
> s_2020 trust_advisors_2020 trust_mutual_funds_2020 trust_insurance_2020 trust_media_2020 intere
> st_2020 inflation_2020 risk_div_2020 educ_yrs gender immigrant born_us race_eth depression_2020
>  health_cond_2020 medicare_2020 medicaid_2020 life_ins_2020 beq_any_2020 num_divorce_2020 num_w
> idow_2020 population_2020 population_3bin_2020

. 
. * ----------------------------------------------------------------------
. * Keep only variables needed for the panel reshape
. * ----------------------------------------------------------------------
. local base_keep "hhidpn"

. if `has_wt' local base_keep "`base_keep' `wtvar'"

. 
. keep `base_keep' `tinv_vars' `ret_vars' `inc_vars' `wealth_vars' `share_vars' `ctrl_vars'

. 
. * ----------------------------------------------------------------------
. * Reshape to long: person–year panel
. * ----------------------------------------------------------------------
. local long_stubs "`ret_stubs' `inc_stubs' `wealth_stubs' `share_stubs' `ctrl_stubs'"

. 
. * If there are no stubs, abort gracefully
. if "`long_stubs'" == "" {
.     display as error "10_build_panel: No time-varying stubs found to reshape."
.     log close
.     exit 0
. }

. 
. display "=== 10_build_panel: Reshaping to long person–year panel ==="
=== 10_build_panel: Reshaping to long person–year panel ===

. reshape long `long_stubs', i(hhidpn) j(year)
(j = 2000 2002 2004 2006 2008 2010 2012 2014 2016 2018 2020 2022)
(variable r1_annual_2000 not found)
(variable r1_annual_win_2000 not found)
(variable r1_annual_w5_2000 not found)
(variable r4_annual_2000 not found)
(variable r4_annual_win_2000 not found)
(variable r4_annual_w5_2000 not found)
(variable r5_annual_2000 not found)
(variable r5_annual_win_2000 not found)
(variable r5_annual_w5_2000 not found)

Data                               Wide   ->   Long
-----------------------------------------------------------------------------
Number of observations           45,234   ->   542,808     
Number of variables                 982   ->   332         
j variable (12 values)                    ->   year
xij variables:
r1_annual_2000 r1_annual_2002 ... r1_annual_2022->r1_annual_
r1_annual_win_2000 r1_annual_win_2002 ... r1_annual_win_2022->r1_annual_win_
r1_annual_w5_2000 r1_annual_w5_2002 ... r1_annual_w5_2022->r1_annual_w5_
r4_annual_2000 r4_annual_2002 ... r4_annual_2022->r4_annual_
r4_annual_win_2000 r4_annual_win_2002 ... r4_annual_win_2022->r4_annual_win_
r4_annual_w5_2000 r4_annual_w5_2002 ... r4_annual_w5_2022->r4_annual_w5_
r5_annual_2000 r5_annual_2002 ... r5_annual_2022->r5_annual_
r5_annual_win_2000 r5_annual_win_2002 ... r5_annual_win_2022->r5_annual_win_
r5_annual_w5_2000 r5_annual_w5_2002 ... r5_annual_w5_2022->r5_annual_w5_
labor_income_real_win_2000 labor_income_real_win_2002 ... labor_income_real_win_2022->labor_incom
> e_real_win_
total_income_real_win_2000 total_income_real_win_2002 ... total_income_real_win_2022->total_incom
> e_real_win_
ln_lab_inc_final_2000 ln_lab_inc_final_2002 ... ln_lab_inc_final_2022->ln_lab_inc_final_
ln_tot_inc_final_2000 ln_tot_inc_final_2002 ... ln_tot_inc_final_2022->ln_tot_inc_final_
wealth_core_2000 wealth_core_2002 ... wealth_core_2022->wealth_core_
wealth_ira_2000 wealth_ira_2002 ... wealth_ira_2022->wealth_ira_
wealth_coreira_2000 wealth_coreira_2002 ... wealth_coreira_2022->wealth_coreira_
wealth_total_2000 wealth_total_2002 ... wealth_total_2022->wealth_total_
wealth_core_d2_2000 wealth_core_d2_2002 ... wealth_core_d2_2022->wealth_core_d2_
wealth_coreira_d2_2000 wealth_coreira_d2_2002 ... wealth_coreira_d2_2022->wealth_coreira_d2_
wealth_d2_2000 wealth_d2_2002 ... wealth_d2_2022->wealth_d2_
wealth_core_d3_2000 wealth_core_d3_2002 ... wealth_core_d3_2022->wealth_core_d3_
wealth_coreira_d3_2000 wealth_coreira_d3_2002 ... wealth_coreira_d3_2022->wealth_coreira_d3_
wealth_d3_2000 wealth_d3_2002 ... wealth_d3_2022->wealth_d3_
wealth_core_d4_2000 wealth_core_d4_2002 ... wealth_core_d4_2022->wealth_core_d4_
wealth_coreira_d4_2000 wealth_coreira_d4_2002 ... wealth_coreira_d4_2022->wealth_coreira_d4_
wealth_d4_2000 wealth_d4_2002 ... wealth_d4_2022->wealth_d4_
wealth_core_d5_2000 wealth_core_d5_2002 ... wealth_core_d5_2022->wealth_core_d5_
wealth_coreira_d5_2000 wealth_coreira_d5_2002 ... wealth_coreira_d5_2022->wealth_coreira_d5_
wealth_d5_2000 wealth_d5_2002 ... wealth_d5_2022->wealth_d5_
wealth_core_d6_2000 wealth_core_d6_2002 ... wealth_core_d6_2022->wealth_core_d6_
wealth_coreira_d6_2000 wealth_coreira_d6_2002 ... wealth_coreira_d6_2022->wealth_coreira_d6_
wealth_d6_2000 wealth_d6_2002 ... wealth_d6_2022->wealth_d6_
wealth_core_d7_2000 wealth_core_d7_2002 ... wealth_core_d7_2022->wealth_core_d7_
wealth_coreira_d7_2000 wealth_coreira_d7_2002 ... wealth_coreira_d7_2022->wealth_coreira_d7_
wealth_d7_2000 wealth_d7_2002 ... wealth_d7_2022->wealth_d7_
wealth_core_d8_2000 wealth_core_d8_2002 ... wealth_core_d8_2022->wealth_core_d8_
wealth_coreira_d8_2000 wealth_coreira_d8_2002 ... wealth_coreira_d8_2022->wealth_coreira_d8_
wealth_d8_2000 wealth_d8_2002 ... wealth_d8_2022->wealth_d8_
wealth_core_d9_2000 wealth_core_d9_2002 ... wealth_core_d9_2022->wealth_core_d9_
wealth_coreira_d9_2000 wealth_coreira_d9_2002 ... wealth_coreira_d9_2022->wealth_coreira_d9_
wealth_d9_2000 wealth_d9_2002 ... wealth_d9_2022->wealth_d9_
wealth_core_d10_2000 wealth_core_d10_2002 ... wealth_core_d10_2022->wealth_core_d10_
wealth_coreira_d10_2000 wealth_coreira_d10_2002 ... wealth_coreira_d10_2022->wealth_coreira_d10_
wealth_d10_2000 wealth_d10_2002 ... wealth_d10_2022->wealth_d10_
leverage_long_2000 leverage_long_2002 ... leverage_long_2022->leverage_long_
leverage_other_2000 leverage_other_2002 ... leverage_other_2022->leverage_other_
share_core_2000 share_core_2002 ... share_core_2022->share_core_
share_m3_ira_2000 share_m3_ira_2002 ... share_m3_ira_2022->share_m3_ira_
share_residential_2000 share_residential_2002 ... share_residential_2022->share_residential_
         age_2000 age_2002 ... age_2022   ->   age_
age_bin_2000 age_bin_2002 ... age_bin_2022->   age_bin_
married_2000 married_2002 ... married_2022->   married_
inlbrf_2000 inlbrf_2002 ... inlbrf_2022   ->   inlbrf_
censreg_2000 censreg_2002 ... censreg_2022->   censreg_
hometown_size_2000 hometown_size_2002 ... hometown_size_2022->hometown_size_
region_pop_group_2000 region_pop_group_2002 ... region_pop_group_2022->region_pop_group_
region_pop3_group_2000 region_pop3_group_2002 ... region_pop3_group_2022->region_pop3_group_
townsize_trust_2000 townsize_trust_2002 ... townsize_trust_2022->townsize_trust_
pop_trust_2000 pop_trust_2002 ... pop_trust_2022->pop_trust_
regional_trust_2000 regional_trust_2002 ... regional_trust_2022->regional_trust_
-----------------------------------------------------------------------------

. 
. * Avoid Stata ambiguous abbreviation (r1_annual vs r1_annual_win): temp-rename _win, then renam
> e _annual -> _annual_nw using varlist so we never type the ambiguous name.
. local r1var "r1_annual_nw"

. local r4var "r4_annual_nw"

. local r5var "r5_annual_nw"

. capture confirm variable r1_annual_win

. if !_rc {
.     rename r1_annual_win __r1win
.     rename r4_annual_win __r4win
.     rename r5_annual_win __r5win
.     foreach v of varlist _all {
  2.         if "`v'" == "r1_annual" {
  3.             rename `v' r1_annual_nw
  4.             continue, break
  5.         }
  6.     }
.     foreach v of varlist _all {
  2.         if "`v'" == "r4_annual" {
  3.             rename `v' r4_annual_nw
  4.             continue, break
  5.         }
  6.     }
.     foreach v of varlist _all {
  2.         if "`v'" == "r5_annual" {
  3.             rename `v' r5_annual_nw
  4.             continue, break
  5.         }
  6.     }
.     rename __r1win r1_annual_win
.     rename __r4win r4_annual_win
.     rename __r5win r5_annual_win
. }

. else {
.     foreach v of varlist _all {
  2.         if "`v'" == "r1_annual" {
  3.             rename `v' r1_annual_nw
  4.             continue, break
  5.         }
  6.     }
.     foreach v of varlist _all {
  2.         if "`v'" == "r4_annual" {
  3.             rename `v' r4_annual_nw
  4.             continue, break
  5.         }
  6.     }
.     foreach v of varlist _all {
  2.         if "`v'" == "r5_annual" {
  3.             rename `v' r5_annual_nw
  4.             continue, break
  5.         }
  6.     }
. }

. 
. * Post-reshape hard check: raw vars must be r1_annual_nw, r4_annual_nw, r5_annual_nw (required 
> for 14)
. foreach v in r1_annual_nw r4_annual_nw r5_annual_nw {
  2.     capture confirm variable `v'
  3.     if _rc {
  4.         display as error "10_build_panel: `v' missing after reshape. Raw returns must be pre
> sent in long panel."
  5.         display as error "  Check that r1_annual_*, r4_annual_*, r5_annual_* were in ret_stu
> bs before reshape."
  6.         log close
  7.         exit 198
  8.     }
  9. }
10_build_panel: r1_annual_nw missing after reshape. Raw returns must be present in long panel.
  Check that r1_annual_*, r4_annual_*, r5_annual_* were in ret_stubs before reshape.
      name:  <unnamed>
       log:  /Volumes/SSD PRO/Github-forks/Chp2-TrustandReturns/Notes/Logs/10_build_panel.log
  log type:  text
 closed on:  11 Feb 2026, 23:11:48
-------------------------------------------------------------------------------------------------
